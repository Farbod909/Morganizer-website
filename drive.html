<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Morganizer</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link href="jbox/jBox.css" rel="stylesheet">
    <link href="jbox/themes/TooltipDark.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <script type="text/javascript">
        if (localStorage.userToken == undefined) {
            location = "login.html";
        }
    </script>
    <script src="js/spin.js"></script>
    <script type="text/javascript">
        var loadingDiv = document.createElement("div");
        loadingDiv.className = "loading_circle";
        loadingDiv.id = "loading_circle";
    </script>
</head>

<body>
    <div id="audio-files" style="display: none;">
        <audio id="click-sound">
            <source src="jbox/audio/bling2.wav" type="audio/wav" />
        </audio>
    </div>
    <!-- NAVIGATION BAR -->
    <div class="navigation_bar">
        <ul id="navbar_list">
            <li class="navbar_item">
                <input type="text" placeholder="search drive" class="searchbox"></input>
            </li>
            <li class="navbar_item">
                <div id="categories">
                    <ul>
                        <li class="navbar_item navbar_link" id="home_link" onclick="location='index.html'">
                            <span class="glyphicon glyphicon-home"></span>
                            <div class="hborder"></div>
                        </li><!--
                        --><li class="navbar_item navbar_link" id="chat_link" onclick="location='chat.html'">
                            <span class="glyphicon glyphicon-comment"></span>
                            <div class="border"></div>
                        </li><!--
                        --><li class="navbar_item navbar_link active" id="drive_link" onclick="location='drive.html'">
                            <span class="glyphicon glyphicon-hdd"></span>
                            <div class="border"></div>
                        </li><!--
                        --><li class="navbar_item navbar_link" id="cal_link" onclick="location='cal.html'">
                            <span class="glyphicon glyphicon-calendar"></span>
                            <div class="border"></div>
                        </li><!--
                        --><li class="navbar_item navbar_link" id="networks_link" onclick="location='networks.html'">
                            <span class="glyphicon glyphicon-globe"></span>
                            <div class="border"></div>
                        </li>
                    </ul>
                </div>
            </li>
            <li class="navbar_item" id="notif_button">
                <span class="glyphicon glyphicon-inbox"></span>
            </li>
            <li class="navbar_item" id="profile_id">
                <img id="small_prof_pic" src="./images/user.jpg"></img>
            </li>
            <li class="navbar_item" id="profile_name">
                <span id="name_link"></span>
            </li>
        </ul>
    </div>
    <div class="triangle_thing_notif hidden"></div>
    <div class="triangle_thing_prof hidden"></div>
    <div id="notif_drop" class="hidden">
        <ul>
            <li class="notif_list_item">hey</li>
            <li class="notif_list_item">hi</li>
            <li class="notif_list_item">ho</li>
        </ul>
    </div>
    <div id="prof_drop" class="hidden">
        <ul>
            <li class="notif_list_item" onclick="location='profile.html';">View Profile and Settings</li>
            <li class="notif_list_item" id="logout_button">Log Out</li>
        </ul>
    </div>
    <div id="darken" class="hidden"></div>
    <!-- END OF NAVIGATION BAR -->

    <!-- BODY -->
    <div class="container-fluid documents_list hidden">
        <div class="grid">
            <input type="file" id="file" class="hidden"></input>
            <div style="z-index:1;" class="doc_frame add_file">
                <span id="add_file_sign" class="glyphicon glyphicon-plus"></span>
            </div>
            <!--<div style="z-index:1;" class="doc_frame image_doc">              // THIS IS A SAMPLE FILE (IMAGE) IN DRIVE
                <div class="hidden confirm_del">
                    <p>Are you sure?</p>
                    <input type="button" value="yes" class="yes"></input>
                    <input type="button" value="no" class="no"></input>
                </div>
                <img src="./images/sample2.jpg" class="doc_preview image_preview" />
                <span class="doc_title">
                    <span class="name">Flower Image</span>
                    <span class="file_size">6.3 MB</span>
                    <span class="glyphicon glyphicon-trash doc_delete"></span>
                </span>
            </div>-->
        </div>
    </div>
    <!-- END OF BODY -->

    <!-- LEFTBAR -->
    <div class="leftbar">
        <ul class="folders_list">
            <li class="drive_name drive_options">
                <div class="btn-group sort_by_dropdown">
                    <button class="button dropdown-toggle" data-toggle="dropdown">Sort By
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li class="sort_by">Date</li>
                        <li class="sort_by">Name</li>
                        <li class="sort_by">Size</li>
                        <li class="sort_by">Type</li>
                    </ul>
                </div>
                <!-- <span class="glyphicon glyphicon-th grid_layout"></span>
                <span class="glyphicon glyphicon-th-list list_layout"></span>  UN-COMMENT WHEN LIST LAYOUT IS READY   -->
            </li>
            <li class="drive_name new_folder">
                <span id="make_drive" class="glyphicon glyphicon-plus"></span>New Folder</li>
            <li class="drive_name">
                <span id="make_drive" data-folderid="" class="glyphicon glyphicon-folder-open def_folder1"></span>All Your Files</li>
            <li class="drive_name">
                <span id="make_drive" class="glyphicon glyphicon-folder-open def_folder2"></span>Team Files</li>
            <li class="drive_name">
                <span id="make_drive" class="glyphicon glyphicon-folder-open def_folder3"></span>Personal Files</li>

        </ul>
    </div>
    <span class="glyphicon glyphicon-chevron-left hide_leftbar"></span>
    <!-- END OF LEFTBAR -->

    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://code.jquery.com/color/jquery.color-2.1.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="js/color-thief.js"></script>
    <script src="jbox/jBox.min.js"></script>
    <script src="js/dropzone.js"></script>
    <script src="js/clamp.min.js"></script>
    <script type="text/javascript" src="js/socket.io.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.1/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="js/navbar.js"></script>
    <script type="text/javascript" src="js/hex.js"></script>
    <script type="text/javascript">

        var currentFolderID = "";
        var chosenSort = "original-order";

        function extToClass(ext) {
            if (ext == "doc" || ext == "docx" || ext == "pages" || ext == "rtf" || ext == "txt") {
                return "word_doc";
            } else if (ext == "key" || ext == "ppt" || ext == "pptx") {
                return "keynote_doc";
            } else if (ext == "xls" || ext == "xlsx" || ext == "numbers" || ext == "_xls" || ext == "xlsb" || ext == "xlsm" || ext == "xltx" || ext == "xlt") {
                return "excel_doc";
            } else if (ext == "pdf") {
                return "pdf_doc";
            } else if (ext == "mp3" || ext == "wav" || ext == "m4a" || ext == "avi" || ext == "wma" || ext == "ogg" || ext == "m4p" || ext == "ra" || ext == "ram" || ext == "rm" || ext == "mid") {
                return "audio_doc";
            } else if (ext == "mp4" || ext == "webm" || ext == "flv" || ext == "mkv" || ext == "ogv" || ext == "mov" || ext == "avi" || ext == "wmv" || ext == "m4p" || ext == "mpg") {
                return "audio_doc";
            } else if (ext == "png" || ext == "jpg" || ext == "jpeg" || ext == "jif" || ext == "jfif" || ext == "gif" || ext == "raw" || ext == "tif" || ext == "bmp" || ext == "rif" || ext == "tiff" || ext == "webp") {
                return "image_doc";
            } else {
                return "default_doc";
            }
        }
        function loadUsersOnFolderModal(modal) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getteammates", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var users = JSON.parse(xhr.responseText);
                        people = users;
                        var content = "";
                        for (var i = 0; i < people.length; i++) {
                            var person = people[i].first + " " + people[i].last;
                            var nameP = "<p class='selected_folder_member' data-username='" + people[i].user + "'>" + person + "</p>"
                            content += nameP;
                        }
                        var modal_content = '<input type="text" class="folder_name" placeholder="Folder Name"></input><br/>Please select who can view the folder:<br/><input type="text" placeholder="Search Names..." id="select_folder_members"></input><br/><div id="selected_folder_members">' +
                        content + '</div><br/><input type="button" class="button make_folder_button" value="Make Folder"></input>'
                        modal.setContent(modal_content);
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username
            }));
        }
        jQuery.fn.flash = function(color, duration) {
            var current = this.css('backgroundColor');
            this.animate({
                    backgroundColor: color
                }, duration / 2)
                .animate({
                    backgroundColor: current
                }, duration / 2);
        }
        function showDropHere() {
            $("#add_file_sign").removeClass("glyphicon-plus")
            $("#add_file_sign").html("Drop Here");
            $(".add_file").css("background-color", "#f5f5f5");
            $("#add_file_sign").css("font-size", "40px");
        }

        function hideDropHere() {
            $("#add_file_sign").addClass("glyphicon-plus")
            $("#add_file_sign").html("");
            $(".add_file").css("background-color", "#e9e9e9")
            $("#add_file_sign").css("font-size", "60px");
        }
        function loadFolders() {
            //$(".def_folder1").attr("data-folderid", localStorage.username);
            $(".def_folder2").attr("data-folderid", localStorage.teamCode);
            $(".def_folder3").attr("data-folderid", localStorage.username);
            request("POST", "/f/getfolders", JSON.stringify({"user":localStorage.username}), function(responseText){
                console.log(responseText);
                var folders = JSON.parse(responseText);
                for (var i = 0; i < folders.length; i++){
                    var li = $(document.createElement("li"));
                    var span = $(document.createElement("span"));
                    li.append(span);
                    li.attr("class", "drive_name");
                    span.attr("id", "make_drive");
                    span.attr("data-folderid", folders[i].folderCode);
                    span.attr("class", "glyphicon glyphicon-folder-open");
                    li.append(folders[i].folderName);
                    $('.folders_list').append(li);
                }
            });
        }

        $(document).ready(function() {

            loadFolders();
            var didClickNew = false;

            document.body.appendChild(loadingDiv);

            folder_modal = new jBox('Modal', {
              attach: $('.new_folder'),
              title: 'New Folder',
              width: 350,
              height: 355,
              onOpen: function() {
                  didClickNew = false;
                  loadUsersOnFolderModal(folder_modal);
                  $(document).on("keyup", '#select_folder_members', function() {
                    var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                    $('#selected_folder_members p').show().filter(function() {
                        var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                        console.log(!~text.indexOf(val));
                        return !~text.indexOf(val);
                    }).hide();
                  });
                  $(document).one("click", '.make_folder_button', function() {
                    // CODE TO CREATE FOLDER HERE
                        didClickNew = true;
                        var folder_name = document.createTextNode($(".folder_name").val())
                        var usersBadges = $("p.clicked");
                        var users = [];
                        for (var i = 0; i < usersBadges.length; i++) {
                            users.push($(usersBadges[i]).attr("data-username"));
                        }
                        request("POST", "/f/newfolder", JSON.stringify({"user":localStorage.username, "people":users, "folderName":$(".folder_name").val()}), function(responseText){
                            var li = $(document.createElement("li"));
                            var span = $(document.createElement("span"));
                            li.append(span);
                            li.attr("class", "drive_name");
                            span.attr("id", "make_drive");
                            span.attr("data-folderid", responseText);
                            span.attr("class", "glyphicon glyphicon-folder-open");
                            li.append(folder_name);
                            $('.folders_list').append(li);
                            folder_modal.close();
                        });
                  });
              }
            });
            loadUsersOnFolderModal(folder_modal);
            $(document).on("click", ".selected_folder_member", function() {
                // do stuff with $(this) when a name has been clicked in group_modal
                if ($(this).hasClass("clicked")) {
                    $(this).removeClass("clicked");
                } else {
                    $(this).addClass('clicked');
                }
            });


            var spinnerOpts = {
                lines: 13 // The number of lines to draw
                    ,
                length: 0 // The length of each line
                    ,
                width: 20 // The line thickness
                    ,
                radius: 42 // The radius of the inner circle
                    ,
                scale: .5 // Scales overall size of the spinner
                    ,
                corners: 1 // Corner roundness (0..1)
                    ,
                color: 'orange' // #rgb or #rrggbb or array of colors
                    ,
                opacity: 0.25 // Opacity of the lines
                    ,
                rotate: 0 // The rotation offset
                    ,
                direction: 1 // 1: clockwise, -1: counterclockwise
                    ,
                speed: 1 // Rounds per second
                    ,
                trail: 60 // Afterglow percentage
                    ,
                fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
                    ,
                zIndex: 2e9 // The z-index (defaults to 2000000000)
                    ,
                className: 'spinner' // The CSS class to assign to the spinner
                    ,
                top: '50%' // Top position relative to parent
                    ,
                left: '50%' // Left position relative to parent
                    ,
                shadow: false // Whether to render a shadow
                    ,
                hwaccel: false // Whether to use hardware acceleration
                    ,
                position: 'absolute' // Element positioning
            }
            spinner = new Spinner(spinnerOpts).spin(loadingDiv);


            var file_modal = new jBox('Modal', {
                width: 300,
                height: 230,
                attach: $('.add_file'),
                title: 'Upload a File',
                onOpen: function() {

                    $("#chosen_file").html("No File Selected");
                    $("#file").val("");
                    $(".file_name")[0].value = "";

                    $(".upload_button").unbind().click(function() {
                        console.log(uploads);

                        var fileName = $(".file_name").val();
                        var teamCode = localStorage.teamCode;
                        var user = localStorage.username;
                        var rawFileName = "";

                        if (uploads.length == undefined) {
                            if (uploads.size > 50000000) {
                                alert("file is too big");
                            } else {
                                rawFileName = uploads.name;
                                var xhr = new XMLHttpRequest();
                                xhr.open("POST", "/f/uploadtodrive?user=" + escape(user) + "&teamcode=" + escape(teamCode) + "&folder=" + escape(currentFolderID) + "&filename=" + escape(fileName) + "&rawname=" + escape(
                                    rawFileName), true);
                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState == 4 && xhr.status == 200) {
                                        if (xhr.responseText != "Too large") {
                                            var data = JSON.parse(xhr.responseText);
                                            var fileSize = data.fileSize;
                                            var fileType = data.fileType;
                                            var fileCode = data.fileCode;
                                            console.log(data);

                                            var imgSrc = "";
                                            var imgClass = "";
                                            var isImg;
                                            if (extToClass(fileType) == "image_doc") {
                                                imgSrc = "/f/getfile?user=" + localStorage.username + "&filecode=" + fileCode;
                                                imgClass = " image_preview";
                                                isImg = true;
                                            } else {
                                                imgSrc = "./images/" + extToClass(fileType).split('_')[0] + ".png";
                                                isImg = false;
                                            }
                                            var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(fileType) + '" data-fileid="' + fileCode + '" title="' + fileName +
                                                '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' +
                                                imgSrc + '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + fileName + '</span><span class="file_size">' + fileSize +
                                                '</span><span class="glyphicon glyphicon-trash doc_delete"></span></span></div>');
                                            $grid.append($newFile).isotope("insert", $newFile);
                                            $newFile.jBox('Tooltip', {
                                                delayOpen: 700,
                                                delayClose: 300,
                                                theme: "TooltipDark",
                                                position: {
                                                    y: 'bottom'
                                                }
                                            });
                                            if(isImg){
                                              thisImg = document.createElement("img");
                                              thisImg.src = imgSrc
                                              thisImg.onload = function(){
                                                var colorThief = new ColorThief();
                                                var color = colorThief.getColor(this);
                                                setTimeout(function(){
                                                  $newFile.css("backgroundColor", "rgb(" + color + ")");
                                                  $newFile.find(".image_preview").show();
                                                  var r = color[0];
                                                  var g = color[1];
                                                  var b = color[2];
                                                  var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                                  if (luma > 170) {
                                                      $newFile.find(".doc_title").children().css("color", "black");
                                                  }
                                                }, 400);
                                              };
                                            }
                                            var title = $newFile.find(".doc_title>span")[0];
                                            $clamp(title, {
                                                clamp: 2
                                            })

                                            file_modal.close();
                                        }

                                    }
                                };
                                xhr.send(uploads);

                            }
                        } else {
                            if (uploads[0].size > 50000000) {
                                alert("file is too big");
                            } else {
                                rawFileName = uploads[0].name;

                                var xhr = new XMLHttpRequest();
                                xhr.open("POST", "/f/uploadtodrive?user=" + escape(user) + "&teamcode=" + escape(teamCode) + "&folder=" + escape(currentFolderID) + "&filename=" + escape(fileName) + "&rawname=" + escape(
                                    rawFileName), true);
                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState == 4 && xhr.status == 200) {
                                        if (xhr.responseText != "fail") {
                                            var data = JSON.parse(xhr.responseText);
                                            var fileSize = data.fileSize;
                                            var fileType = data.fileType;
                                            var fileCode = data.fileCode;
                                            console.log(data);

                                            var imgSrc = "";
                                            var imgClass = "";
                                            var isImg;
                                            if (extToClass(fileType) == "image_doc") {
                                                imgSrc = "/f/getfile?user=" + localStorage.username + "&filecode=" + fileCode;
                                                imgClass = " image_preview";
                                                isImg = true;
                                            } else {
                                                imgSrc = "./images/" + extToClass(fileType).split('_')[0] + ".png";
                                                isImg = false;
                                            }
                                            var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(fileType) + '" data-fileid="' + fileCode + '" title="' + fileName +
                                                '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' +
                                                imgSrc + '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + fileName + '</span><span class="file_size">' + fileSize +
                                                '</span><span class="glyphicon glyphicon-trash doc_delete"></span></span></div>');
                                            $grid.append($newFile).isotope("insert", $newFile);
                                            $newFile.jBox('Tooltip', {
                                                delayOpen: 700,
                                                delayClose: 300,
                                                theme: "TooltipDark",
                                                position: {
                                                    y: 'bottom'
                                                }
                                            });
                                            if(isImg){
                                              thisImg = document.createElement("img");
                                              thisImg.src = imgSrc
                                              thisImg.onload = function(){
                                                var colorThief = new ColorThief();
                                                var color = colorThief.getColor(this);
                                                setTimeout(function(){
                                                  $newFile.css("backgroundColor", "rgb(" + color + ")");
                                                  $newFile.find(".image_preview").show();
                                                  var r = color[0];
                                                  var g = color[1];
                                                  var b = color[2];
                                                  var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                                  if (luma > 170) {
                                                      $newFile.find(".doc_title").children().css("color", "black");
                                                  }
                                                }, 400);
                                              };
                                            }
                                            var title = $newFile.find(".doc_title>span")[0];
                                            $clamp(title, {
                                                clamp: 2
                                            })

                                            file_modal.close();
                                        }

                                    }
                                };
                                xhr.send(uploads[0]);
                            }
                        }
                    });
                }
            });
            var file_modal_content =
                "<input type='button' class='button file_choose' value='Choose File'></input><p id='chosen_file'>No File Selected</p><input type='text' class='file_name' placeholder='File Name'></input><input type='button' class='button upload_button' value='Upload'></input>"
            file_modal.setContent(file_modal_content);
            $(".file_choose").click(function() {
                $("#file").trigger("click");
            });

            document.getElementById("file").onchange = function() {
                uploads = this.files;
                if (this.files.length == 1) {
                    document.getElementById("chosen_file").innerHTML = this.files[0].name;
                    setTimeout(function() {
                        $("#chosen_file").flash("#0099ff", 1000);
                    }, 300);
                } else {
                    document.getElementById("chosen_file").innerHTML = "Multiple Selected";
                    setTimeout(function() {
                        $("#chosen_file").flash("#0099ff", 1000);
                    }, 300);
                }
            };
            var myDropzone = new Dropzone(".add_file", {
                url: "#",
                createImageThumbnails: false,
                clickable: false,
                previewTemplate: "<div id='preview-template' style='display: none;''>",
                uploadMultiple: false
            });
            myDropzone.on("addedfile", function(file) {
                uploads = file;
                file_modal.open();
                document.getElementById("chosen_file").innerHTML = file.name;
                setTimeout(function() {
                    $("#chosen_file").flash("#0099ff", 1000);
                }, 300);
            });


            $("html").on("dragenter", function(event) {
                event.preventDefault();
                event.stopPropagation();
                showDropHere();
            });
            $("html").on("drop", function(event) {
                event.preventDefault();
                event.stopPropagation();
                hideDropHere();
            });
            $(".add_file").on("drop", function(event) {
                event.preventDefault();
                event.stopPropagation();
                hideDropHere();
            });
            $("html").on("mouseenter", function(event) {
                event.stopPropagation();
                event.preventDefault();
                hideDropHere();
            })
            $("html").on('dragover', function() {
                event.preventDefault();
            });
            $("html").mouseleave(function() {
                hideDropHere();
            });



            function hideLeftbar(time, button) {
                $(".leftbar").velocity({
                    left: "-260px"
                }, time);
                $(".documents_list").velocity({
                    left: "40px"
                }, time);
                $(button).removeClass("glyphicon-chevron-left").addClass("glyphicon-chevron-right");
                $(button).velocity({
                    left: "10px"
                }, time);
                setTimeout(function() {
                    $(".documents_list").css("width", "calc(100vw - 60px)")
                    $grid.isotope();
                }, time)
            }

            function showLeftbar(time, button) {
                $(".leftbar").velocity({
                    left: "0px"
                }, time);
                $(".documents_list").velocity({
                    left: "300px"
                }, time);
                $(button).removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-left");
                $(button).velocity({
                    left: "220px"
                }, time);
                setTimeout(function() {
                    $(".documents_list").css("width", "calc(100vw - 320px)")
                    $grid.isotope();
                }, time);
            }
            $(".hide_leftbar").click(function() {
                if ($(this).hasClass("glyphicon-chevron-left")) {
                    hideLeftbar(300, this);
                } else {
                    showLeftbar(300, this);
                }
            });
            if ($(window).width() < 825) {
                hideLeftbar(0, ".hide_leftbar");
            }

        });

        function debounce(fn, threshold) {
            var timeout;
            return function debounced() {
                if (timeout) {
                    clearTimeout(timeout);
                }

                function delayed() {
                    fn();
                    timeout = null;
                }
                timeout = setTimeout(delayed, threshold || 100);
            }
        }
        $(window).load(function() {
            spinner.stop();
            $(".documents_list").fadeIn(400).removeClass("hidden");

            var qsRegex;

            $grid = $('.grid').isotope({
                itemSelector: '.doc_frame',
                layoutMode: 'fitRows',
                transformEnabled: false,
                isAnimated: false,
                filter: function() {
                    return qsRegex ? $(this).text().match(qsRegex) : true;
                },
                getSortData: {
                    name: '.name',
                    size: function(itemElem) {
                        var size = $(itemElem).find('.file_size').text();
                        if (size.indexOf("MB") > -1) {
                            size = size.substring(0, size.indexOf("MB"));
                            return parseFloat(size.replace(/[\(\)]/g, '')) * 1000;
                        } else {
                            return parseFloat(size.replace(/[\(\)]/g, ''));
                        }
                    },
                    type: function(itemElem) {
                        if ($(itemElem).hasClass("add_file")) {
                            return "a"
                        } else if ($(itemElem).hasClass("word_doc")) {
                            return "a";
                        } else if ($(itemElem).hasClass("pdf_doc")) {
                            return "b";
                        } else if ($(itemElem).hasClass("keynote_doc")) {
                            return "c";
                        } else if ($(itemElem).hasClass("excel_doc")) {
                            return "d";
                        } else if ($(itemElem).hasClass("audio_doc")) {
                            return "e";
                        } else if ($(itemElem).hasClass("default_doc")) {
                            return "f";
                        } else if ($(itemElem).hasClass("image_doc")) {
                            return "g";
                        } else {
                            return "z";
                        }
                    }
                }

            });


            // $('.doc_frame:not(.add_file)').jBox('Tooltip', {
            //     delayOpen: 700,
            //     delayClose: 300,
            //     theme: "TooltipDark",
            //     position: {
            //         y: 'bottom'
            //     }
            // });

            $(document).on("click", ".doc_frame:not(.add_file)", function(e) {
                var a = $(e.target);
                var b = $(this).find(".doc_delete");
                var c = $(this).find("input");
                if (a[0] != b[0] && a[0] != c[0] && a[0] != c[1]) {
                    location = "/f/getfile?user=" + localStorage.username + "&filecode=" + $(this).attr("data-fileid");
                    //alert($(this).find(".doc_title>span").html()); // title of document
                }
            });
            $(document).on("click", ".doc_delete", function() {
                var frame = $(this).parent().parent();
                frame.find(".confirm_del").css("background-color", frame.css("background-color"));
                frame.find(".confirm_del").fadeIn(150).removeClass("hidden");
                $(frame).click(function(e) {
                    var a = $(e.target);
                    var b = $(this).find(".doc_delete");
                    var c = $(this).find("input");
                    if (a[0] != b[0] && a[0] != c[0] && a[0] != c[1]) {
                        frame.find(".confirm_del").fadeOut(150);
                    }
                });
                $(frame.find(".yes")).click(function() {
                    var fileCode = frame.attr("data-fileid");
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/f/deletefile", true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            if (xhr.responseText == "success") {
                                $grid.isotope('remove', frame).isotope();
                            }
                        }
                    };
                    xhr.send(JSON.stringify({
                        "user": localStorage.username,
                        "fileCode": fileCode
                    }));
                });
                $(frame.find(".no")).click(function() {
                    frame.find(".confirm_del").fadeOut(150);
                });
            });

            $(document).on("mouseenter", ".doc_frame", function() {
                //originalColor = rgb2hex($(this).css("backgroundColor"));
                $(this).css({
                    backgroundColor: "#" + rgb2hex($(this).css('backgroundColor')).darkenHexColorBy(25)
                })
            });
            $(document).on("mouseleave", ".doc_frame", function() {
                $(this).css({
                    backgroundColor: "#" + rgb2hex($(this).css('backgroundColor')).lightenHexColorBy(25)
                })
            });


            $(document).on("click", ".drive_name:not(.new_folder, .drive_options)", function() {
              if( !$(this).hasClass('selected') ){
                if( $(this).find("#make_drive").attr("data-folderid") == "" ){
                  $(".add_file").hide();
                }else{
                  $(".add_file").show();
                }
                $(".drive_name:not(.new_folder, .drive_options)").removeClass("selected");
                $(this).addClass("selected");
                currentFolderID = $(this).children().first().attr("data-folderid");
                //GET FILES WITH FOLDER ID
                $grid.isotope("remove", $(".doc_frame:not(.add_file)")).isotope()

                fileImg = [];
                tempFile = [];
                imgCounter = 0;

                var url = "/f/showfiles";
                if (currentFolderID == ""){
                    url = "/f/showallfiles";
                }

                var xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        if (xhr.responseText != "fail") {
                            var files = JSON.parse(xhr.responseText);
                            for (var i = 0; i < files.length; i++) {
                                var imgSrc = "";
                                var imgClass = "";
                                var isImg = false;
                                if (extToClass(files[i].fileType) == "image_doc") {
                                    imgSrc = "/f/getfile?user=" + localStorage.username + "&filecode=" + files[i].fileCode;
                                    imgClass = " image_preview"
                                    isImg = true
                                } else {
                                    imgSrc = "./images/" + extToClass(files[i].fileType).split('_')[0] + ".png";
                                }
                                var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(files[i].fileType) + '" data-fileid="' + files[i].fileCode + '" title="' + files[i].fileName +
                                    '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' + imgSrc +
                                    '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + files[i].fileName + '</span><span class="file_size">' + files[i].fileSize +
                                    '</span><span class="glyphicon glyphicon-trash doc_delete"></span></span></div>');
                                $grid.append($newFile).isotope("appended", $newFile);
                                $newFile.jBox('Tooltip', {
                                    delayOpen: 700,
                                    delayClose: 300,
                                    theme: "TooltipDark",
                                    position: {
                                        y: 'bottom'
                                    }
                                });
                                if(isImg){
                                  fileImg[imgCounter] = document.createElement("img");
                                  fileImg[imgCounter].src = imgSrc;
                                  $(fileImg[imgCounter]).attr("data-order", imgCounter)
                                  tempFile[imgCounter] = $newFile;

                                  fileImg[imgCounter].onload = function(){
                                    var colorThief = new ColorThief();
                                    var color = colorThief.getColor(this);
                                    tempFile[$(this).attr("data-order")].css("background-color", "rgb(" + color + ")");
                                    tempFile[$(this).attr("data-order")].find(".image_preview").show();
                                    var r = color[0];
                                    var g = color[1];
                                    var b = color[2];
                                    var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                    if (luma > 170) {
                                        tempFile[$(this).attr("data-order")].find(".doc_title").css("color", "black");
                                    }
                                  };

                                  imgCounter++;
                                }
                            }
                            var titles = $(".doc_title>span");
                            for (i = 0; i < titles.length; i++) {
                                $clamp(titles[i], {
                                    clamp: 2
                                })
                            }
                        }
                    }
                };
                xhr.send(JSON.stringify({
                    "user": localStorage.username,
                    "folder": currentFolderID,
                    "teamCode": localStorage.teamCode
                }));
              }
            });
            $($(".drive_name")[2]).trigger("click");

            var $quicksearch = $('.searchbox').keyup(debounce(function() {
                qsRegex = new RegExp($quicksearch.val(), 'gi');
                $grid.isotope();
            }, 200));

            $(".sort_by").click(function() {
                var chosenSort = "";
                $(".sort_by").removeClass("selected");
                $(this).addClass("selected");
                chosenSort = $(this).html().toLowerCase();
                if (chosenSort === "date") {
                    chosenSort = "original-order";
                }
                $grid.isotope({
                    sortBy: chosenSort
                })
            });

            var folderid;
            $(document).on("contextmenu", ".drive_name:not(.new_folder, .drive_options)", function(e){

                  e.preventDefault();
                  $(".drop").remove();
                  folderid = $(e.target).find("#make_drive").attr("data-folderid");
                  if( folderid != localStorage.teamCode && folderid != localStorage.username && folderid != "" ){
                    var drop = $("<div class='drop'><li id='folder_options' class='drop_item'><span class='glyphicon glyphicon-cog'></span> Options</li><li id='folder_delete' class='drop_item'><span class='glyphicon glyphicon-trash'></span> Delete</li></div>");
                  }else{
                    var drop = $("<div class='drop'><li id='folder_options' class='drop_item'><span class='glyphicon glyphicon-cog'></span> Options</li></div>");
                  }
                  drop.css("top", e.pageY + 7);
                  drop.css("left", e.pageX - 28);

                  $("body").append(drop);

                  $(document).click(function(){
                       $(".drop").remove();
                       $(".drive_name:not(.new_folder, .drive_options)").unbind("contextmenu");
                  });

                  return false;
            });
            $(document).on("click", "#folder_options", function(){
              alert("the folder id is: " + folderid);

              // SHOW FOLDER OPTIONS

            });
            $(document).on("click", "#folder_delete", function(){
              $("#make_drive[data-folderid='"+folderid+"']").parent().remove();

              // DELETE FOLDER

            });



        });
        window.onunload = function() {};
    </script>
</body>

</html>
