<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MorTeam</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel='stylesheet' href='css/perfect-scrollbar.min.css' />
    <link href="jbox/jBox.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <script type="text/javascript">
        if (localStorage.userToken == undefined) {
            location = "login";
        }
    </script>
    <script src="js/spin.js"></script>
    <script type="text/javascript">
        var loadingDiv = document.createElement("div");
        loadingDiv.className = "loading_circle";
        loadingDiv.id = "loading_circle";
    </script>

</head>

<body class="chat_body">
    <!-- NAVIGATION BAR -->
    <div id="audio-files" style="display: none;">
        <audio id="click-sound">
            <source src="jbox/audio/bling2.wav" type="audio/wav" />
        </audio>
    </div>
    <div class="nav_dropdown">
      <p onclick="location='index'">Home</p>
      <p onclick="location='chat'" style="background-color: orange">Chat</p>
      <p onclick="location='drive'">Drive</p>
      <p onclick="location='cal'">Calendar</p>
      <p onclick="location='networks'">Networks</p>
    </div>
    <div class="navigation_bar">
        <ul id="navbar_list">
          <li class="navbar_item navbar_title" onclick="location='index'">
              MorTeam
          </li>
          <li class="navbar_item searchbox_list_item">
              <input type="text" placeholder="search" class="searchbox"></input>
          </li>
          <li class="navbar_item glyph_link chat_btn menu_btn active" onclick="location='chat'">
              <span class="glyphicon glyphicon-comment"></span>
          </li>
          <li class="navbar_item glyph_link drive_btn menu_btn" onclick="location='drive'">
              <span class="glyphicon glyphicon-hdd"></span>
          </li>
          <li class="navbar_item glyph_link cal_btn menu_btn" onclick="location='cal'">
              <span class="glyphicon glyphicon-calendar"></span>
          </li>
          <li class="navbar_item glyph_link networks_btn menu_btn" onclick="location='networks'">
              <span class="glyphicon glyphicon-globe"></span>
          </li>
          <div class="navbar_item right_links">
            <li class="navbar_item glyph_link menu">
                <span class="glyphicon glyphicon-menu-hamburger"></span>
            </li>
            <li class="navbar_item glyph_link" id="notif_button">
                <span class="glyphicon glyphicon-inbox"></span>
            </li>
            <img class="profile_id" id="small_prof_pic" src="./images/user.jpg"></img>
            <span class="profile_name" id="name_link"></span>
          </div>
        </ul>
    </div>
    <div id="notif_drop" class="hidden">
        <ul>
            <li class="notif_list_item">hey</li>
            <li class="notif_list_item">hi</li>
            <li class="notif_list_item">ho</li>
        </ul>
    </div>
    <div id="prof_drop" class="hidden">
        <ul>
            <li class="notif_list_item" onclick="location='user?user='+localStorage.username;">View Profile and Settings</li>
            <li class="notif_list_item" id="logout_button">Log Out</li>
        </ul>
    </div>
    <div class="hidden" id="darken"></div>
    <!-- END OF NAVIGATION BAR -->

    <!-- BODY -->
    <div class="wrapper chat_wrapper">
      <div class="chat_area hidden" id="chat_area"></div>
      <div class="reply_box hidden">
          <textarea rows="1" class="reply_textarea"></textarea>
          <input type="button" class="send_button" value="send"></input>
      </div>
    </div>
    <div class="ads">
      <div class="ad"></div>
      <div class="ad2"></div>
    </div>
    <!-- END OF BODY -->

    <!-- LEFTBAR -->
    <div class="leftbar">
        <ul class="users_list">
            <li class="chat_name make_group">
                <span id="make_group" class="glyphicon glyphicon-plus"></span>Make Group</li>
        </ul>
    </div>
    <span class="glyphicon glyphicon-chevron-left hide_leftbar"></span>

    <!-- END OF LEFTBAR -->
    <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="js/clamp.min.js"></script>
    <script src="jbox/jBox.min.js"></script>
    <script type="text/javascript" src="js/socket.io.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="js/autosize.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script src='js/perfect-scrollbar.jquery.min.js'></script>

    <script type="text/javascript">
        var ta = document.querySelectorAll('textarea');
        autosize(ta);
    </script>
    <script type="text/javascript">
        var chatcode = "";
        var socket = io.connect();
        var people = [];
        var usersInGroup = [];
        var currentGroupName = "";
        // FUNCTION DEFINITIONS
        function getTeammates() {
            console.log(localStorage.teamCode);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getteammates", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var users = JSON.parse(xhr.responseText);
                        people = users;
                        listUsers(users);
                        $(".small_prof_pic").load(function() {
                            $(this).css('visibility', 'visible').hide().fadeIn(300);
                        })
                    }
                    console.log(xhr.responseText);
                    getAndLoadGroupChats(); //gets list of group chats and displays on the leftbar
                    console.log("Called getAndLoadGroupChats() here");
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "teamCode":localStorage.teamCode
            }));
        }

        function listUsers(users) {
            for (var i = 0; i < users.length; i++) {
                var status = users[i].status;
                var name = users[i].first + " " + users[i].last;
                var li = $(document.createElement("li"));
                li.attr("class", "chat_name");
                li.attr("data-username2", users[i].user);
                li.attr("data-name", name);
                li.attr("data-type", "private");
                li.html('<a href="#"><img src="/f/getPic?user='+users[i].user+'" onError="this.src=\'./images/user.jpg\'" class="small_prof_pic temp other_user_pic' + i + ' ' + status + '"id="small_prof_pic"></img></a>' + '<span class="chat_name_display">' + name + '</span>');
                li.attr("title", name);
                $('.users_list').append(li);
                if (i == 0) {
                    $(li).trigger("click");
                }
            }
        }
        //Don't allow "=" sign
        function createMessageSelf(content, name, isLoad) {
            if (isLoad) {
                $('.chat_area').prepend("<div class='bubble_wrapper'><div class='self_bubble'>" + content.replace(/</g, "&lt").replace(/\r?\n/g, '<br />') + "</div></div>");
            } else {
                $('.chat_area').append("<div class='bubble_wrapper'><div class='self_bubble'>" + content.replace(/</g, "&lt").replace(/\r?\n/g, '<br />') + "</div></div>");
                $(".chat_area").animate({
                    scrollTop: $('.chat_area')[0].scrollHeight
                }, 400);
            }
        }
        function play(){
            //var beep = new Audio("jbox/audio/bling2.mp3");
            //beep.play();
            //var sound = document.getElementById("beep");

            //sound.play();
        }
        function createMessageOther(content, name, username, isLoad) {
            if (isLoad) {
                $('.chat_area').prepend("<div class='bubble_wrapper'><div class='other_bubble'><img class='show' id='small_prof_pic' src='/f/getPic?user=" + username + "' onError='this.src=\"./images/user.jpg\"'></img>" + "<p class='chat_opponent'>" + name.replace(/</g,
                        "&lt").replace(/\r?\n/g, '<br />') +
                    ": </p class='chat_opponent'>" +
                    content.replace(/</g, "&lt").replace(/\r?\n/g, '<br />') + "</div></div>")
            } else {
                $('.chat_area').append("<div class='bubble_wrapper'><div class='other_bubble'><img class='show' id='small_prof_pic' src='/f/getPic?user=" + username + "' onError='this.src=\"./images/user.jpg\"'></img>" + "<p class='chat_opponent'>" + name.replace(/</g,
                        "&lt").replace(/\r?\n/g, '<br />') +
                    ": </p class='chat_opponent'>" +
                    content.replace(/</g, "&lt").replace(/\r?\n/g, '<br />') + "</div></div>")
                $(".chat_area").animate({
                    scrollTop: $('.chat_area')[0].scrollHeight
                }, 400);
            }
        }

        function sendMessage(message) {
            console.log(chatcode)
            if (message.replace(/\s/g, '') != "") {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/f/addmessage", true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        console.log(chatcode)
                        if (xhr.responseText == "success") {
                            socket.emit("newmessage", {
                                "user": localStorage.username,
                                "name": localStorage.firstName + " " + localStorage.lastName,
                                "message": message,
                                "chatcode": chatcode,
                                "recievers":usersInGroup,
                                "chatname":currentGroupName,
                                "token":localStorage.userToken
                            });
                        }
                    }
                };
                xhr.send(JSON.stringify({
                    "name": localStorage.firstName + " " + localStorage.lastName,
                    "username": localStorage.username,
                    "message": message.replace(/'/g, "''").replace(/</g, "&lt"),
                    "chatcode": chatcode,
                    "token": localStorage.userToken
                }));
            }
        }

        function loadGroupMessages(chatID) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/loadgroupmessages", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    $(".chat_area").empty();
                    chatcode = chatID;
                    var data = JSON.parse(xhr.responseText);
                    var messages = data.messages;
                    var groupUsers = data.users;
                    socket.emit("updateclient", {
                        "user": localStorage.username,
                        "chatcode": chatcode,
                        "teamcode": localStorage.teamCode,
                        "token": localStorage.userToken
                    });
                    socket.on("updated", function(data) {
                        if(messages.length == 0){
                          spinner.stop();
                        }
                        $(".chat_area").empty();
                        usersInGroup = [];
                        for (var i = 0; i < groupUsers.length; i++){
                            usersInGroup.push(groupUsers[i].user);
                        }
                        for (var i = 0; i < 20; i++) {
                            if (i >= messages.length) {
                                spinner.stop();
                                break;
                            } else {
                                var message = messages[messages.length - i - 1];
                                if (message.user == localStorage.username) {
                                    createMessageSelf(message.message, message.sender, true);
                                } else {
                                    createMessageOther(message.message, message.sender, message.user, true);
                                }
                                if (i == 19){
                                  spinner.stop();
                                }
                            }
                        }
                        $('.chat_area').scrollTop($('.chat_area')[0].scrollHeight);
                    });
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "chatID": chatID
            }));
        }

        function getChatCodeAndLoadMessages(user2, username2) {
            chatcode = "";
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/loadmessages", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        $(".chat_area").empty();
                        var data = JSON.parse(xhr.responseText);
                        chatcode = data.chatcode;
                        var messages = data.messages;
                        socket.emit("updateclient", {
                            "user": localStorage.username,
                            "chatcode": chatcode,
                            "teamcode": localStorage.teamCode,
                            "token": localStorage.userToken
                        });
                        socket.on("updated", function(data) {
                            if(messages.length == 0){
                              spinner.stop();
                            }
                            console.log("updated");
                            $(".chat_area").empty();
                            usersInGroup = [];
                            usersInGroup.push(username2);
                            for (var i = 0; i < 20; i++) {
                                if (i >= messages.length) {
                                    spinner.stop();
                                    break;
                                } else {
                                    var message = messages[messages.length - i - 1];
                                    console.log(messages[i].user);
                                    if (message.user == localStorage.username) {
                                        createMessageSelf(message.message, message.sender, true);
                                    } else {
                                        createMessageOther(message.message, message.sender, message.user, true);
                                    }
                                    if(i == 19){
                                      spinner.stop();
                                    }
                                }
                            }
                            // $(".chat_area").animate({
                            // 	scrollTop: $('.chat_area')[0].scrollHeight
                            // }, 400);
                            $('.chat_area').scrollTop($('.chat_area')[0].scrollHeight);
                        });
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user1": {
                    "name": localStorage.firstName + " " + localStorage.lastName,
                    "username": localStorage.username
                },
                "user2": {
                    "name": user2,
                    "username": username2
                }
            }));
        }

        function getAndLoadGroupChats() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getgroupchats", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var groups = JSON.parse(xhr.responseText);
                    console.log(localStorage.username);
                    for (var i = 0; i < groups.length; i++) {
                        var li = $(document.createElement("li"));
                        li.attr("class", "chat_name");
                        li.attr("data-type", "group");
                        li.attr("data-groupname", groups[i].groupName);
                        li.attr("data-groupid", groups[i].groupID);
                        li.attr("title", groups[i].groupName);
                        li.html('<a href="#"><img src="f/getPic?user='+groups[i].groupName+'" onError="this.src=\'images/group.png\'" class="small_prof_pic show"id="small_prof_pic"></img></a>' + '<span class="chat_name_display">' + groups[i].groupName + '</span><span class="glyphicon glyphicon-cog list_right options_li"></span>');
                        $('.users_list').append(li);
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username
            }));
        }



        function isTyping(user) { // just pass FIRST NAME into user
            $('.chat_area').append("<div class='bubble_wrapper'><div class='other_bubble'><img class='show' id='small_prof_pic' src='./images/1.jpg'></img>" + user + " is typing...</div></div>");
        }

        function deleteLastIsTyping() {
            $('.chat_area').remove(".bubble_wrapper:last"); // this should work, im not sure though
        }
        function collision($div1, $div2) {
          var x1 = $div1.offset().left;
          var y1 = $div1.offset().top;
          var h1 = $div1.outerHeight(true);
          var w1 = $div1.outerWidth(true);
          var b1 = y1 + h1;
          var r1 = x1 + w1;
          var x2 = $div2.offset().left;
          var y2 = $div2.offset().top;
          var h2 = $div2.outerHeight(true);
          var w2 = $div2.outerWidth(true);
          var b2 = y2 + h2;
          var r2 = x2 + w2;

          if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
          return true;
        }

        $(document).ready(function() {

            getTeammates(); // gets list of teammates and displays on the leftbar

            document.body.appendChild(loadingDiv);

            spinnerOpts = {
                lines: 13 // The number of lines to draw
                    ,
                length: 0 // The length of each line
                    ,
                width: 20 // The line thickness
                    ,
                radius: 42 // The radius of the inner circle
                    ,
                scale: .5 // Scales overall size of the spinner
                    ,
                corners: 1 // Corner roundness (0..1)
                    ,
                color: 'orange' // #rgb or #rrggbb or array of colors
                    ,
                opacity: 0.25 // Opacity of the lines
                    ,
                rotate: 0 // The rotation offset
                    ,
                direction: 1 // 1: clockwise, -1: counterclockwise
                    ,
                speed: 1 // Rounds per second
                    ,
                trail: 60 // Afterglow percentage
                    ,
                fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
                    ,
                zIndex: 2e9 // The z-index (defaults to 2000000000)
                    ,
                className: 'spinner' // The CSS class to assign to the spinner
                    ,
                top: '50%' // Top position relative to parent
                    ,
                left: '50%' // Left position relative to parent
                    ,
                shadow: false // Whether to render a shadow
                    ,
                hwaccel: false // Whether to use hardware acceleration
                    ,
                position: 'absolute' // Element positioning
            }


            var options_modal = new jBox('Modal', {
                width: 350,
                height: 'auto',
                title: 'Options',
                onOpen: function() {

                }
            });
            $(document).on("click", ".add_group_member", function(){
              $(this).replaceWith("<span class='member_search_span'><input type='text' placeholder='Search Users' class='member_search'><div class='search_drop member_search_drop'><ul><li class='member_option'>Bob Jones</li><li class='member_option'>Bob Jones</li></ul></div></input><span class='glyphicon glyphicon-remove cancel'></span></span>");
              $(".member_search").focus();
            })
            $(document).on("keyup", ".member_search", function(){
              if($(this).val() != ""){
                $(".member_search_drop").show();
              }else{
                $(".member_search_drop").hide();
              }
            });
            $(document).on("click", ".cancel", function(){
              $(".member_search_span").replaceWith('<li class=" add_group_member"><span class="glyphicon glyphicon-plus"></span><span class="group_member_name">Add Member(s)</span></li>');
            });
            $(document).on("click", ".member_option", function(){
              $(".member_search_drop").hide();
              $(".member_search_span").replaceWith('<li class=" add_group_member"><span class="glyphicon glyphicon-plus"></span><span class="group_member_name">Add Member(s)</span></li>');
              $(".add_group_member").after('<li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">Bob Jones</span><span class="member_remove glyphicon glyphicon-remove"></span></li>') //POSSIBLE ERROR IN THE FUTURE DUE TO .add_group_member NOT EXISTING AT THE TIME OF APPENDING
            });
            $(document).on("click", ".member_remove", function(){
              if (window.confirm("Are you sure?")) {
                $(this).parent().remove();
              }
            })
            $(document).on("click", ".options_li", function(){
              var currentName = $(this).prev().html();
              options_modal.open();
              options_modal.setContent('<input type="text" class="change_name" value="'+ currentName +'"></input><br/><div class="group_members"><ul class="current_group_members"><li class=" add_group_member"><span class="glyphicon glyphicon-plus"></span><span class="group_member_name">Add Member(s)</span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li></ul></div><input type="button" class="button leave_group" value="Leave Group"></input><input type="button" class="button delete_group" value="Delete Group"></input><input type="button" class="button save_options" value="Save"></input>')
            });

            var group_modal = new jBox('Modal', {
                width: 350,
                height: 340,
                attach: $('.make_group'),
                title: 'Make a Group',
                onOpen: function() {
                    //loadUsersOnModal(people);
                    getScopesAndLoadUsersOnModal(people);
                    /*console.log(document.getElementById("select_group_names"));
                    var group_names = $('#selected_names_div p');
                    $('#select_group_names').keyup(function() {
                        console.log("nigeer");
                        var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                        group_names.show().filter(function() {
                            var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                            return !~text.indexOf(val);
                        }).hide();
                    });*/
                }
            });

            socket.on("updateindicator", function(data){
                var items = $(".users_list li");
                items.each(function(index,li) {
                    if ($(li).attr("data-username2") == data.user && !$(li).hasClass("make_group") && $(li).attr("data-type") == "private"){
                        if ($(li).children().children().hasClass("online")){
                            $(li).children().children().removeClass("online");
                        }
                        else if ($(li).children().children().hasClass("offline")){
                            $(li).children().children().removeClass("offline");
                        }
                        $(li).children().children().addClass(data.status);
                    }
                });
            });

            function getScopesAndLoadUsersOnModal(people){
                var allScopes = [];
                request("POST", "/f/getpublicscopesforteam", JSON.stringify({"user":localStorage.username, "teamCode":localStorage.teamCode}), function(responseText){
                    var scopes = JSON.parse(responseText);
                    for (var i = 0; i < scopes.length; i++){
                        allScopes.push(scopes[i].scopeName);
                    }
                    request("POST", "/f/getyourscopes", JSON.stringify({"user":localStorage.username, "teamCode":localStorage.teamCode}), function(responseText2){
                        var scopes = JSON.parse(responseText2);
                        for (var i = 0; i < scopes.length; i++){
                            allScopes.push(scopes[i].scopeName);
                        }
                        var allUniqueScopes = [];
                        $.each(allScopes, function(i, el){
                            if($.inArray(el, allUniqueScopes) === -1) allUniqueScopes.push(el);
                        });
                        //return allUniqueScopes;
                        var content = "";
                        for (var i = 0; i < allUniqueScopes.length; i++) {
                            var scopeP = "<p class='selected_group_name scope_badge'>" + allUniqueScopes[i] + "</p>"
                            content += scopeP;
                        }
                        for (var i = 0; i < people.length; i++) {
                            var person = people[i].first + " " + people[i].last;
                            var nameP = "<p class='selected_group_name' data-username='" + people[i].user + "'>" + person + "</p>"
                            content += nameP;
                        }
                        var initialContent =
                            "<input type='text' placeholder='Group Name' id='group_name'><br/>Please select the members of the group:<br/><input type='text' placeholder='Search Names...' id='select_group_names'></input><br/><div id='selected_names_div'>" +
                            content + "</div><br/><input type='button' value='Make Group' id='group_button'></input>"
                        group_modal.setContent(initialContent);
                        var group_names = $('#selected_names_div p');
                        $('#select_group_names').keyup(function() {
                            var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                            group_names.show().filter(function() {
                                var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                                return !~text.indexOf(val);
                            }).hide();
                        });
                    });
                });
            }

            function scopesToUsersAndCreateGroup(){
                var chatName = $("#group_name").val();
                var usersBadges = $("p.clicked:not(.scope_badge)");
                var scopeBadges = $(".scope_badge.clicked");
                var groupImageSrc = "placeholder"
                var users = [];
                var scopes = [""];
                for (var i = 0; i < usersBadges.length; i++) {
                    users.push($(usersBadges[i]).attr("data-username"));
                }
                for (var i = 0; i < scopeBadges.length; i++) {
                    scopes.push($(scopeBadges[i]).html());
                }
                var allUsers = [];
                var done = 0;
                for (var i = 0; i < scopes.length; i++){
                    console.log(scopes)
                    request("POST", "/f/getusersinscope", JSON.stringify({"user":localStorage.username, "teamCode":localStorage.teamCode, "scopeName":scopes[i]}), function(responseText){
                        var usersFromScope = JSON.parse(responseText);
                        for (var j = 0; j < usersFromScope.length; j++){
                            if (usersFromScope[j].user != localStorage.username){
                                allUsers.push(usersFromScope[j].user);
                            }
                        }
                        if (done++ == scopes.length - 1){
                            users = users.concat(allUsers);
                            var uniqueUsers = [];
                            $.each(users, function(i, el){
                                if($.inArray(el, uniqueUsers) === -1) uniqueUsers.push(el);
                            });
                            users = uniqueUsers;
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "/f/creategroupchat", true);
                            xhr.onreadystatechange = function() {
                                if (xhr.readyState == 4 && xhr.status == 200) {
                                    var data = JSON.parse(xhr.responseText);
                                    var li = $(document.createElement("li"));
                                    li.attr("class", "chat_name");
                                    li.attr("data-type", "group");
                                    li.attr("data-groupname", chatName);
                                    li.attr("data-groupid", data.chatID);
                                    li.html('<a href="#"><img src="f/getPic?user='+ groupImageSrc +'" onError="this.src=\'images/group.png\'" class="small_prof_pic show"id="small_prof_pic"></img></a>' + '<span class="chat_name_display">'+chatName+'</span><span class="glyphicon glyphicon-cog list_right options_li"></span>');
                                    $('.users_list').append(li);
                                    group_modal.close();
                                }
                            };
                            xhr.send(JSON.stringify({
                                "creator": localStorage.username,
                                "chatName": chatName.replace(/'/g, "''"),
                                "users": users,
                                "scopes":scopes,
                                "teamCode":localStorage.teamCode
                            }));
                        }
                    });
                }
            }

            function loadUsersOnModal(people) {
                /*var content = "";
                var scopes = getScopes();
                console.log(scopes)
                for (var i = 0; i < scopes.length; i++) {
                    var scopeP = "<p class='selected_group_name scope_badge'>" + scopes[i] + "</p>"
                    content += scopeP;
                }
                for (var i = 0; i < people.length; i++) {
                    var person = people[i].first + " " + people[i].last;
                    var nameP = "<p class='selected_group_name' data-username='" + people[i].user + "'>" + person + "</p>"
                    content += nameP;
                }
                var initialContent =
                    "<input type='text' placeholder='Group Name' id='group_name'><br/>Please select the members of the group:<br/><input type='text' placeholder='Search Names...' id='select_group_names'></input><br/><div id='selected_names_div'>" +
                    content + "</div><br/><input type='button' value='Make Group' id='group_button'></input>"
                group_modal.setContent(initialContent);*/
            }
            function fixAdLayout(){
              if( $(".ad").css("display") == "none" ){
                if($(".hide_leftbar").hasClass("glyphicon-chevron-left")){
                  console.log("no ad, sidebar");
                  $(".chat_wrapper").css("width", "calc(100vw - 260px)");
                }else{
                  $(".chat_wrapper").css("width", "100vw");
                  console.log("no ad, no sidebar");
                }
              }else{
                if($(".hide_leftbar").hasClass("glyphicon-chevron-left")){
                  $(".chat_wrapper").css("width", "calc(100vw - 460px)");
                  console.log("ad, sidebar");
                }else{
                  $(".chat_wrapper").css("width", "calc(100vw - 200px)");
                  console.log("ad, no sidebar");
                }
              }
            }
            $(document).on("click", "#group_button", function() {
                /*var chatName = $("#group_name").val();
                var usersBadges = $("p.clicked");
                var scopeBadges = $(".scope_badge.clicked");
                var groupImageSrc = "placeholder"
                var users = [];
                var scopes = [];
                for (var i = 0; i < usersBadges.length; i++) {
                    users.push($(usersBadges[i]).attr("data-username"));
                }
                for (var i = 0; i < scopeBadges.length; i++) {
                    scopes.push($(scopeBadges[i]).html());
                }
                var usersInScopes = scopesToUsers(scopes);
                setTimeout(function(){
                    users.concat(usersInScopes);
                    var uniqueUsers = [];
                    $.each(users, function(i, el){
                        if($.inArray(el, uniqueUsers) === -1) uniqueUsers.push(el);
                    });
                    users = uniqueUsers;
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/f/creategroupchat", true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            var data = JSON.parse(xhr.responseText);
                            var li = $(document.createElement("li"));
                            li.attr("class", "chat_name");
                            li.attr("data-type", "group");
                            li.attr("data-groupname", chatName);
                            li.attr("data-groupid", data.chatID);
                            li.html('<a href="#"><img src="f/getPic?user='+ groupImageSrc +'" onError="this.src=\'images/group.png\'" class="small_prof_pic show"id="small_prof_pic"></img></a>' + '<span class="chat_name_display">'+chatName+'</span>');
                            $('.users_list').append(li);
                            group_modal.close();
                        }
                    };
                    xhr.send(JSON.stringify({
                        "creator": localStorage.username,
                        "chatName": chatName.replace(/'/g, "''"),
                        "users": users
                    }));
                }, 3000);
                */
                scopesToUsersAndCreateGroup();
            });

            if (navigator.platform.indexOf("Mac") == -1) {
                $('.chat_area').perfectScrollbar();
            }

            $(document).on("click", "li.chat_name:not(.make_group, .selected)", function(e) {
              var a = $(e.target);
              var b = $(this).find(".list_right");
              if (a[0] != b[0] && a[0] != b[1]){
                  spinner = new Spinner(spinnerOpts).spin(loadingDiv);
                $("li.chat_name").removeClass("selected");
                $(this).addClass("selected");
                $(".chat_area").removeClass("hidden");
                $(".reply_box").removeClass("hidden");
                //play();
                autosize.update(ta);
                if ($(this).hasClass("chat_name")) {
                    if ($(this).attr("data-type") == "private") {
                        currentGroupName = "";
                        getChatCodeAndLoadMessages($(this).attr("data-name"), $(this).attr("data-username2"));
                        //console.log($(this).attr("data-name") + ", " + $(this).attr("data-username2"));
                    } else {
                        currentGroupName = "";
                        currentGroupName = $(this).attr("data-groupname");
                        loadGroupMessages($(this).attr("data-groupid"));
                    }
                }
              }
            });
            $(document).on("click", ".delete_li", function(){
              if (window.confirm("Are you sure?")) {
                $(this).parent().remove();
              }
            });



            var isBlur = false;
            $(window).blur(function(){
                isBlur = true;
                //b.trigger("click");
            });
            $(window).focus(function(){
                isBlur = false;
            });

            socket.on("message", function(data) {
                console.log(data.user == localStorage.username);
                if (data.user == localStorage.username) {
                    createMessageSelf(data.message, data.name, false);
                    //console.log("ran");
                }
                else {
                    createMessageOther(data.message, data.name, data.user, false);
                    if (isBlur){
                        $('#audio-files').find('audio#click-sound')[0].play();
                        $('#audio-files').find('audio#click-sound')[0].currentTime = 0;
                    }
                }

            });


            $('.chat_area').scrollTop($('.chat_area').prop("scrollHeight")); // scrolls to bottom of conversation

            var replyInitialHeight = $('.reply_textarea').height(); // initial height of reply text box, it's used to check for height changes later
            $('.reply_textarea').bind("input", function() { //checks for height change of reply text box and adjusts height of chat area accordingly
                if ($(this).height() != replyInitialHeight) {
                    replyInitialHeight = $(this).height();
                    $('.chat_area').css('height', "calc(100% - 30px - " + $(this).height() + "px)");
                    $(".chat_area").animate({
                        scrollTop: $('.chat_area')[0].scrollHeight
                    }, 400); // scrolls to bottom of conversation
                }
            });
            $('.reply_textarea').focus(function() { // scrolls to bottom of conversation when reply box is focused
                $(".chat_area").animate({
                    scrollTop: $('.chat_area')[0].scrollHeight
                }, 400);
            });
            $('.reply_textarea').keypress(function(e) { // changes events for enter and shift+enter to send and add line break respectively
                if (e.shiftKey && e.which == 13) {
                    // goes to next line
                } else if (e.which == 13) {
                    e.preventDefault();
                    $('.send_button').trigger("click");
                    $('.reply_textarea').val('');
                    autosize.update(ta);
                    $('.chat_area').css('height', "calc(100% - 30px - " + $(this).height() + "px)");
                }
            });
            $('.send_button').click(function() {
                //createMessage($('.reply_textarea').val());
                sendMessage($('.reply_textarea').val());
                $('.reply_textarea').val(''); // empties reply text box
                autosize.update(ta); // resizes reply text box
                $('.chat_area').css('height', "calc(100vh - 58px - " + $(this).height() + "px)"); // resizes div.chat_area according to changes that occur in above line
            });

            $(document).on("mouseenter", "li.chat_name", function() {
                $(this).attr("id", "hovered");
            });
            $(document).on("mouseleave", "li.chat_name", function() {
                $(this).removeAttr("id");
            });

            $(document).on("click", ".selected_group_name", function() {
                // do stuff with $(this) when a name has been clicked in group_modal
                if ($(this).hasClass("clicked")) {
                    $(this).removeClass("clicked");
                } else {
                    $(this).addClass('clicked');
                }
            });

            function hideLeftbar(time, button){
              $(".leftbar").velocity({left: "-260px"}, { duration: time, queue: false });
              $(".wrapper").velocity({left: "0px"}, { duration: time, queue: false });
              $(".wrapper").velocity({width: "+=260px"}, { duration: time, queue: false });
              $(button).removeClass("glyphicon-chevron-left").addClass("glyphicon-chevron-right");
              $(button).velocity({left: "10px"}, { duration: time, queue: false });
              setTimeout(function(){
                $(".wrapper").css("width", "calc(100vw - 200px)");
                fixAdLayout();
              }, time + time)
            }
            function showLeftbar(time, button){
              $(".leftbar").velocity({left: "0px"}, { duration: time, queue: false });
              $(".wrapper").velocity({left: "260px"}, { duration: time, queue: false });
              $(".wrapper").velocity({width: "-=260px"}, { duration: time, queue: false });
              $(button).removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-left");
              $(button).velocity({left: "220px"}, { duration: time, queue: false });
              setTimeout(function(){
                $(".wrapper").css("width", "calc(100vw - 460px)");
                fixAdLayout();
              }, time + time)
            }
            $(".hide_leftbar").click(function(){
              if($(this).hasClass("glyphicon-chevron-left")){
                hideLeftbar(300, this);
              }else{
                showLeftbar(300, this);
              }
            });
            if($(window).width() < 825){
              hideLeftbar(0, ".hide_leftbar");
            }

            $(".searchbox").keyup(function(){
              var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
              $('li.chat_name').show().filter(function() {
                  var text = $(this).find(".chat_name_display").text().replace(/\s+/g, ' ').toLowerCase();
                  console.log(!~text.indexOf(val));
                  return !~text.indexOf(val);
              }).hide();
            })

            // $(window).resize(function(){
            //   if( collision( $(".ads"), $(".chat_wrapper") ) ){
            //     $(".ad").hide();
            //   }else{
            //     $(".ad").show();
            //   }
            // })
            $(window).resize(function(){
              if( $(".ad").css("display") == "none" ){
                if($(".hide_leftbar").hasClass("glyphicon-chevron-left")){
                  console.log("no ad, sidebar");
                  $(".chat_wrapper").css("width", "calc(100vw - 260px)");
                }else{
                  $(".chat_wrapper").css("width", "100vw");
                  console.log("no ad, no sidebar");
                }
              }else{
                if($(".hide_leftbar").hasClass("glyphicon-chevron-left")){
                  $(".chat_wrapper").css("width", "calc(100vw - 460px)");
                  console.log("ad, sidebar");
                }else{
                  $(".chat_wrapper").css("width", "calc(100vw - 200px)");
                  console.log("ad, no sidebar");
                }
              }
            });
        });
        $(window).load(function(){
          function fixAdLayout(){
            if( $(".ad").css("display") == "none" ){
              if($(".hide_leftbar").hasClass("glyphicon-chevron-left")){
                console.log("no ad, sidebar");
                $(".chat_wrapper").css("width", "calc(100vw - 260px)");
              }else{
                $(".chat_wrapper").css("width", "100vw");
                console.log("no ad, no sidebar");
              }
            }else{
              if($(".hide_leftbar").hasClass("glyphicon-chevron-left")){
                $(".chat_wrapper").css("width", "calc(100vw - 460px)");
                console.log("ad, sidebar");
              }else{
                $(".chat_wrapper").css("width", "calc(100vw - 200px)");
                console.log("ad, no sidebar");
              }
            }
          }
          fixAdLayout();
          setTimeout(function(){
            fixAdLayout();
          }, 200)

        });

        window.onunload = function() {};
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-66914799-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>

</html>
