<!DOCTYPE html>
<html lang="en">

  <head>
  	<meta charset="utf-8" />
  	<meta http-equiv="X-UA-Compatible" content="IE=edge">
  	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Morganizer</title>
  	<link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
  	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  	<link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <script type="text/javascript">
    if(localStorage.userToken == undefined){
      location="login.html";
    }
    </script>
  </head>
  <body>
    <!-- NAVIGATION BAR --> 
    <div class="navigation_bar">
      <ul id="navbar_list">
        <li class="navbar_item"><input type="text" placeholder="search chat" class="searchbox"></input></li>
        <li class="navbar_item">
          <div id="categories">
           <ul>
            <li class="navbar_item navbar_link" id="home_link" onclick="location='index.html'"><span class="glyphicon glyphicon-home"></span><div class="hborder"></div></li><!-- 
            --><li class="navbar_item navbar_link active" id="chat_link" onclick="location='chat.html'"><span class="glyphicon glyphicon-comment"></span><div class="border"></div></li><!--
            --><li class="navbar_item navbar_link" id="drive_link" onclick="location='drive.html'"><span class="glyphicon glyphicon-hdd"></span><div class="border"></div></li><!--
            --><li class="navbar_item navbar_link" id="cal_link" onclick="location='cal.html'"><span class="glyphicon glyphicon-calendar"></span><div class="border"></div></li><!--
            --><li class="navbar_item navbar_link" id="settings_link" onclick="location='settings.html'"><span class="glyphicon glyphicon-cog"></span><div class="border"></div></li>
           </ul> 
          </div>
        </li>
        <li class="navbar_item" id="notif_button"><span class="glyphicon glyphicon-inbox"></span></li>
        <li class="navbar_item" id="profile_id"><img id="small_prof_pic" src="./images/user.jpg"></img></li>
        <li class="navbar_item" id="profile_name"><span id="name_link">User</span></li>
      </ul>
    </div>
    <div class="triangle_thing_notif"></div>
    <div class="triangle_thing_prof"></div>
    <div id="notif_drop">
      <ul>
        <li class="notif_list_item">hey</li>
        <li class="notif_list_item">hi</li>
        <li class="notif_list_item">ho</li>
      </ul> 
    </div>
    <div id="prof_drop">
      <ul>
        <li class="notif_list_item" onclick="location='profile.html';">View Profile</li>
        <li class="notif_list_item" id="logout_button">Log Out</li>
      </ul> 
    </div>
    <div id="darken"></div>
    <!-- END OF NAVIGATION BAR --> 

    <!-- BODY -->
    <div class="chat_area">
      <div class="bubble_wrapper">
        <div class="self_bubble">Lorem ipsum dolor?</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>it amet, consectetur adipiscing elit</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>mollit anim id est laborum.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">Duis aute irure dolor in reprehenderit</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>Ut enim ad minim veniam, quis nostrud exercitation ullamco ea commodo consequat.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">Lorem ipsum dolor?</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>it amet, consectetur adipiscing elit</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>mollit anim id est laborum.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">Duis aute irure dolor in reprehenderit</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>Ut enim ad minim veniam, quis nostrud exercitation ullamco ea commodo consequat.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">Lorem ipsum dolor?</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>it amet, consectetur adipiscing elit</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>mollit anim id est laborum.</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">Duis aute irure dolor in reprehenderit</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum</div>
      </div>
      <div class="bubble_wrapper">
        <div class="self_bubble">labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor</div>
      </div>
      <div class="bubble_wrapper">
        <div class="other_bubble"><img class="temp"id="small_prof_pic" src="./images/1.jpg"></img>Ut enim ad minim veniam, quis nostrud exercitation ullamco ea commodo consequat.</div>
      </div>
    </div>
    <div class="reply_box">
      <textarea rows="1" class="reply_textarea"></textarea>
      <input type="button" class="send_button" value="send"></input>
    </div>
    <!-- END OF BODY -->

    <!-- LEFTBAR -->
    <div class="leftbar">
      <ul class="users_list">
        <li class="chat_name"><span id="make_group" class="glyphicon glyphicon-plus"></span>Make Group</li>
      </ul>
    </div>
    <!-- END OF LEFTBAR -->
    
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/navbar.js"></script>
    <script type="text/javascript" src="js/autosize.js"></script>
    <script type="text/javascript">
      var ta = document.querySelectorAll('textarea');
      autosize(ta);
    </script>
    <script type="text/javascript">

      // FUNCTION DEFINITIONS
      function getTeammates() {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/f/getteammates", true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4&&xhr.status == 200){
            if (xhr.responseText != "fail"){
              var users = JSON.parse(xhr.responseText);
              listUsers(users);
            }
            console.log(xhr.responseText);
          }
        };
        xhr.send(JSON.stringify({"user":localStorage.username}));
      }
      function listUsers(users){
        for(var i=0; i<users.length; i++){
          var status = "online";
          $('.users_list').append('<li class="chat_name"><a href="#"><img class="temp ' + status + '"id="small_prof_pic" src="./images/user.jpg"></img></a>' + users[i].first + ' ' + users[i].last + '</li>')
        }
      }
      function createMessage(content){
        $('.chat_area').append("<div class='bubble_wrapper'><div class='self_bubble'>"+content.replace(/\r?\n/g, '<br />')+"</div></div>")
        $(".chat_area").animate({ scrollTop: $('.chat_area')[0].scrollHeight}, 400);
      }

      $(document).ready(function(){

        $('.chat_area').scrollTop($('.chat_area').prop("scrollHeight")); // scrolls to bottom of conversation
		
        getTeammates(); // gets list of teammates and displays on the leftbar
        
        var replyInitialHeight = $('.reply_textarea').height(); // initial height of reply text box, it's used to check for height changes later
        $('.reply_textarea').bind("input", function() {    //checks for height change of reply text box and adjusts height of chat area accordingly
          if($(this).height() != replyInitialHeight){
            replyInitialHeight = $(this).height();
            $('.chat_area').css('height', "calc(100vh - 80px - " + $(this).height() + "px)");
            $(".chat_area").animate({ scrollTop: $('.chat_area')[0].scrollHeight}, 400); // scrolls to bottom of conversation
          } 
        });
        $('.reply_textarea').focus(function() {  // scrolls to bottom of conversation when reply box is focused
          $(".chat_area").animate({ scrollTop: $('.chat_area')[0].scrollHeight}, 400);
        });  
        $('.reply_textarea').keypress(function(e){ // changes events for enter and shift+enter to send and add line break respectively
          	if(e.shiftKey && e.which == 13) {
            	// goes to next line
          	}else if(e.which == 13){
            	e.preventDefault();
            	$('.send_button').trigger("click");
            	$('.reply_textarea').val('');
            	autosize.update(ta);
            	$('.chat_area').css('height', "calc(100vh - 80px - " + $(this).height() + "px)");
          	}
        });
        $('.send_button').click(function(){
          	createMessage($('.reply_textarea').val());
          	$('.reply_textarea').val(''); // empties reply text box
            autosize.update(ta); // resizes reply text box
            $('.chat_area').css('height', "calc(100vh - 80px - " + $(this).height() + "px)"); // resizes div.chat_area according to changes that occur in above line
        });
        
      });
      
      window.onunload = function(){}; 
    </script>
  </body>
</html>