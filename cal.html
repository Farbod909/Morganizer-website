<!DOCTYPE html>
<html lang="en">

  <head>
  	<meta charset="utf-8" />
  	<meta http-equiv="X-UA-Compatible" content="IE=edge">
  	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Morganizer</title>
  	<link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
  	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  	<link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <script src="jbox/jBox.css"></script>
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <link href="jbox/jBox.css" rel="stylesheet">
    <script type="text/javascript">
    if(localStorage.userToken == undefined){
      location="login";
    }
    </script>
  </head>
  <body class="cal_body">
      <div id="audio-files" style="display: none;">
          <audio id="click-sound">
              <source src="jbox/audio/bling2.wav" type="audio/wav" />
          </audio>
      </div>
    <!-- NAVIGATION BAR -->
    <div class="nav_dropdown">
      <p onclick="location='index'">Home</p>
      <p onclick="location='chat'">Chat</p>
      <p onclick="location='drive'">Drive</p>
      <p onclick="location='cal'" style="background-color: orange">Calendar</p>
      <p onclick="location='networks'">Networks</p>
    </div>
    <div class="navigation_bar">
        <ul id="navbar_list">
          <li class="navbar_item navbar_title" onclick="location='index'">
              MorTeam
          </li>
          <li class="navbar_item searchbox_list_item">
              <input type="text" placeholder="search" class="searchbox"></input>
          </li>
          <li class="navbar_item glyph_link chat_btn menu_btn" onclick="location='chat'">
              <span class="glyphicon glyphicon-comment"></span>
          </li>
          <li class="navbar_item glyph_link drive_btn menu_btn" onclick="location='drive'">
              <span class="glyphicon glyphicon-hdd"></span>
          </li>
          <li class="navbar_item glyph_link cal_btn menu_btn active" onclick="location='cal'">
              <span class="glyphicon glyphicon-calendar"></span>
          </li>
          <li class="navbar_item glyph_link networks_btn menu_btn" onclick="location='networks'">
              <span class="glyphicon glyphicon-globe"></span>
          </li>
          <div class="navbar_item right_links">
            <li class="navbar_item glyph_link menu">
                <span class="glyphicon glyphicon-menu-hamburger"></span>
            </li>
            <li class="navbar_item glyph_link" id="notif_button">
                <span class="glyphicon glyphicon-inbox"></span>
            </li>
            <img class="profile_id" id="small_prof_pic" src="./images/user.jpg"></img>
            <span class="profile_name" id="name_link"></span>
          </div>
        </ul>
    </div>
    <div id="notif_drop" class="hidden">
      <ul>
        <li class="notif_list_item">hey</li>
        <li class="notif_list_item">hi</li>
        <li class="notif_list_item">ho</li>
      </ul>
    </div>
    <div id="prof_drop" class="hidden">
      <ul>
        <li class="notif_list_item" onclick="location='profile';">View Profile and Settings</li>
        <li class="notif_list_item" id="logout_button">Log Out</li>
      </ul>
    </div>
    <div id="darken" class="hidden"></div>
    <!-- END OF NAVIGATION BAR -->

    <!-- BODY -->
    <div class="wrapper cal_wrapper">
      <div class="container-fluid cal_container">
        <div class="row cal_row">
          <div class="timeline col-xl-6 col-lg-6 col-md-6 col-sm-12 col-xs-12">
            <!-- <div class="day">
              <div class="day_of_month">28</div><input type="button" class="add_event" value="+" title="Add Event"></input>
              <div class="day_content">
                <h4 class="day_name">Sunday</h4>
                <ul class="day_list">
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                </ul>
              </div>
            </div> -->
          </div>
          <div class="cal_right col-xl-6 col-lg-6 col-md-6 col-sm-12 col-xs-12">
            <div class="events_overview">
              <h3 class="u_events_title">Upcoming Events</h3>
              <div class="events_container">
                <ul class="events_list">
                  <li>Under Construction</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                </ul>
              </div>
            </div>
            <div class="jobs_overview">
              <h3 class="u_events_title">&nbsp;Your Tasks</h3>
              <div class="events_container">
                <ul class="events_list jobs_list">
                  <li>Under Construction</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                  <li>Programming meeting in 285</li>
                  <li>All newbies will take quiz</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END OF BODY -->

    <!-- LEFTBAR -->
    <div class="leftbar">
      <ul>
        <li class="month_name year_select">
            <div class="btn-group year_dropdown">
                <button class="button dropdown-toggle" data-toggle="dropdown"><span class="selected_year"></span>
                    <span class="caret"></span>
                </button>
                <ul class="years dropdown-menu">
                </ul>
            </div>
            <!-- <span class="glyphicon glyphicon-th grid_layout"></span>
            <span class="glyphicon glyphicon-th-list list_layout"></span>  UN-COMMENT WHEN LIST LAYOUT IS READY   -->
        </li>
        <li class="month_name m1" data-month="1"><span id="make_group" class="glyphicon glyphicon-calendar"></span>January</li>
        <li class="month_name m2" data-month="2"><span id="make_group" class="glyphicon glyphicon-calendar"></span>February</li>
        <li class="month_name m3" data-month="3"><span id="make_group" class="glyphicon glyphicon-calendar"></span>March</li>
        <li class="month_name m4" data-month="4"><span id="make_group" class="glyphicon glyphicon-calendar"></span>April</li>
        <li class="month_name m5" data-month="5"><span id="make_group" class="glyphicon glyphicon-calendar"></span>May</li>
        <li class="month_name m6" data-month="6"><span id="make_group" class="glyphicon glyphicon-calendar"></span>June</li>
        <li class="month_name m7" data-month="7"><span id="make_group" class="glyphicon glyphicon-calendar"></span>July</li>
        <li class="month_name m8" data-month="8"><span id="make_group" class="glyphicon glyphicon-calendar"></span>August</li>
        <li class="month_name m9" data-month="9"><span id="make_group" class="glyphicon glyphicon-calendar"></span>September</li>
        <li class="month_name m10" data-month="10"><span id="make_group" class="glyphicon glyphicon-calendar"></span>October</li>
        <li class="month_name m11" data-month="11"><span id="make_group" class="glyphicon glyphicon-calendar"></span>November</li>
        <li class="month_name m12" data-month="12"><span id="make_group" class="glyphicon glyphicon-calendar"></span>December</li>
      </ul>
    </div>
    <span class="glyphicon glyphicon-chevron-left hide_leftbar"></span>
    <!-- END OF LEFTBAR -->


    <script type="text/javascript" src="js/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="jbox/jBox.min.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript">
        var now = new Date();
        var currentDay = now.getDate();
        var currentYear = now.getFullYear();
        var currentMonth = now.getMonth() + 1;
      function loadUsersOnEventModal(modal) {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/f/getteammates", true);
          xhr.onreadystatechange = function() {
              if (xhr.readyState == 4 && xhr.status == 200) {
                  if (xhr.responseText != "fail") {
                      var users = JSON.parse(xhr.responseText);
                      people = users;
                      var content = "";
                      for (var i = 0; i < people.length; i++) {
                          var person = people[i].first + " " + people[i].last;
                          var nameP = "<p class='selected_event_member' data-username='" + people[i].user + "'>" + person + "</p>"
                          content += nameP;
                      }
                      var modal_content = '<input type="text" class="event_name" placeholder="Title"></input><br/><textarea class="event_description" placeholder="Short Description (Optional)"></textarea><br/>Please select who should see the event:<br/><input type="text" placeholder="Search Names..." id="select_event_members"></input><br/><div id="selected_event_members">' +
                      content + '</div><br/><input type="button" class="button make_event_button" value="Make Event"></input>'
                      modal.setContent(modal_content);
                  }
              }
          };
          xhr.send(JSON.stringify({
              "user": localStorage.username,
              "teamCode": localStorage.teamCode
          }));
      }
      function loadUpcomingEvents(){
          //Currently shows every event, later show only first 10-20 events
          request("POST", "/f/getupcomingevents", JSON.stringify({"user":localStorage.username, "currentTime":Date.now()}), function(responseText){
              var events = JSON.parse(responseText);
              var eventList = $(".events_list:not(.jobs_list)");
              eventList.empty();
              for (var i = 0; i < events.length; i++){
                  var event = events[i];
                  var eventDate = " (" + getDayOfWeek(event.month, event.day, event.year) + " - " + event.month + "/" + event.day + "/" + event.year + ")";
                  var li = document.createElement("li");
                  $(li).html( "<span class='bold'>" + event.eventName + eventDate + "</span>" + "<br/><div class='indented'>" + event.eventDesc + "</div>" )
                  $(eventList).append($(li));
              }
          });

      }

      function loadEvents(month, year){
          request("POST", "/f/getevents", JSON.stringify({"user":localStorage.username, "month":month, "year":year}), function(responseText){
              var events = JSON.parse(responseText);
              for (var i = 0; i < events.length; i++){
                  var event = events[i];
                  var day = event.day;
                  var dayListOfEventDay = $(".d"+day).children().children().next();
                  var li = document.createElement("li")
                  $(li).html( "<span class='bold'>" + event.eventName + "</span>&nbsp;<span title='Record Attendance' class='glyphicon glyphicon-list-alt leaders_only attendance'></span>" + "<br/><div class='indented'>" + event.eventDesc + "</div>" )
                  $(li).attr("data-eventID", event.eventID);
                  $(dayListOfEventDay).append($(li));
              }
              if (month == currentMonth && year == currentYear){
                var scrollPix = $(".d"+currentDay).offset().top - $(window).height()*0.5 + $(".d"+currentDay).height()*0.5;
                $('.timeline').scrollTop(scrollPix);
              }
          });
      }
      function loadAttendanceModal(modal, id){
          var content = "";
          request("POST", "/f/getattendance", JSON.stringify({"user":localStorage.username, "eventID":id}), function(responseText){
              var users = JSON.parse(responseText);
              console.log(responseText)
              for (var i = 0; i < users.length; i++){
                  var user = users[i].user;
                  var isPresent = users[i].isPresent;//string
                  //var person = userInfo(user).name;
                  var teammates = JSON.parse(localStorage.teammates);
                  var person = "";
                  if (user == localStorage.username){
                      person = localStorage.firstName + " " + localStorage.lastName;//because teammates does not include yourself
                  }
                  else {
                      person = teammates[user].name;
                  }
                  if (isPresent == "true"){
                      var nameP = "<p class='selected_present_member isPresent' data-username='" + user + "'>" + person + "</p>"
                      content += nameP;
                  }
                  else {
                      var nameP = "<p class='selected_present_member' data-username='" + user + "'>" + person + "</p>"
                      content += nameP;
                  }
              }
              var modal_content = 'Please select the members who attended:<br/><input type="text" placeholder="Search Names..." id="select_present_members"></input><br/><a class="select_all_link">Select All</a><br/><div id="selected_present_members">' +
              content + '</div><br/><input type="button" class="button record_attendance_button" value="Save"></input>'
              modal.setContent(modal_content);
          });

      }
      $(document).ready(function(){
        var didClickNew = false;
        var dayList;
        var currentAttendanceEvent = "";
        loadUpcomingEvents();

        event_modal = new jBox('Modal', {
          // attach: $('.add_event'),
          title: 'New Event',
          width: 350,
          height: 445,
          onOpen: function() {
              didClickNew = false;
              loadUsersOnEventModal(event_modal);
              $(document).on("keyup", '#select_event_members', function() {
                var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                $('#selected_event_members p').show().filter(function() {
                    var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                    //console.log(!~text.indexOf(val));
                    return !~text.indexOf(val);
                }).hide();
              });
          }
        });
        //loadUsersOnEventModal(event_modal);
        attendance_modal = new jBox('Modal', {
          // attach: $('.add_event'),
          title: 'Record Attendace',
          width: 350,
          height: 305,
          onOpen: function() {
              //didClickNew = false;
              loadAttendanceModal(attendance_modal, currentAttendanceEvent);
              $(document).on("keyup", '#select_present_members', function() {
                var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                $('#selected_present_members p').show().filter(function() {
                    var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                    //console.log(!~text.indexOf(val));
                    return !~text.indexOf(val);
                }).hide();
              });
          }
        });
        $(document).on("click", '.record_attendance_button', function() {
            var people = [];
            var usersPresent = $("p.isPresent");
            var usersNotPresent = $("p.selected_present_member:not(.isPresent)");
            for (var i = 0; i < usersPresent.length; i++) {
                people.push({"user":$(usersPresent[i]).attr("data-username"), "isPresent":"true"});
            }
            for (var i = 0; i < usersNotPresent.length; i++) {
                people.push({"user":$(usersNotPresent[i]).attr("data-username"), "isPresent":"false"});
            }
            console.log(usersNotPresent)
            var eventID = currentAttendanceEvent;
            request("POST", "/f/updateattendance", JSON.stringify({"user":localStorage.username, "updatedList":people, "eventID":eventID}), function(responseText){
                if (responseText == "success"){
                    attendance_modal.close();
                }
            });
        });
        $(document).on("click", '.make_event_button', function() {
            if (!didClickNew){
                didClickNew = true;
                var dayNum = $(dayList).parent().prev().prev().html();
                var users = $("p.clicked");
                var people = [];
                for (var i = 0; i < users.length; i++) {
                    people.push($(users[i]).attr("data-username"));
                }
                var eventName = $(".event_name").val().replace(/'/g, "''").replace(/</g, "&lt");
                var eventDesc = $(".event_description").val().replace(/'/g, "''").replace(/</g, "&lt");
                var timeStampOfDate = new Date(Date.UTC(yearViewing, monthViewing - 1, dayNum, 23, 59, 59)).getTime();

                request("POST", "/f/addevent", JSON.stringify({"user":localStorage.username, "people":people, "month":monthViewing, "day":dayNum, "year":yearViewing, "timeStamp":timeStampOfDate, "eventName":eventName, "eventDesc":eventDesc}), function(responseText){
                    if (typeof(responseText) != "undefined"){
                        var li = document.createElement("li");
                        $(li).html( "<span class='bold'>" + eventName.replace(/''/g, "'") + "</span>&nbsp;<span title='Record Attendance' class='glyphicon glyphicon-list-alt leaders_only attendance'></span>" + "<br/><div class='indented'>" + eventDesc.replace(/''/g, "'") + "</div>" )
                        $(li).attr("data-eventID", responseText);
                        $(dayList).append($(li));
                        loadUpcomingEvents();
                        event_modal.close();
                    }
                });
            }
        });
        $(document).on("click", '.record_attendance_button', function() {
            if (!didClickNew){
                didClickNew = true;
                // save attendance
            }
        });

        $(document).on("click", ".add_event", function(){
          event_modal.open();
          dayList = $(this).next().find(".day_list");
        });
        $(document).on("click", ".attendance", function(){
          currentAttendanceEvent = $(this).prev().parent().attr("data-eventID");
          attendance_modal.open();
        });

        $(document).on("click", ".selected_event_member", function() {
            if ($(this).hasClass("clicked")) {
                $(this).removeClass("clicked");
            } else {
                $(this).addClass('clicked');
            }
        });
        $(document).on("click", ".selected_present_member", function() {
            if ($(this).hasClass("isPresent")) {
                $(this).removeClass("isPresent");
            } else {
                $(this).addClass('isPresent');
            }
        });
        $(document).on("click", ".select_all_link", function() {
          if($(this).html() == "Select All"){
            $(".selected_present_member").addClass("isPresent");
            $(this).html("Unselect All")
          }else{
            $(".selected_present_member").removeClass("isPresent");
            $(this).html("Select All");
          }
        });


        var selectedYear = now.getFullYear();
        var monthViewing = "";
        var yearViewing = "";
        $(".selected_year").html( selectedYear );

        for( i=0 ; i<5 ; i++){
          var year = document.createElement("li");
          $(year).addClass("year");
          $(year).html( now.getFullYear() + i )
          $(".years").append(year)
          if(i==0){
            $(year).addClass("selected");
          }
        }

        $(document).on("click", ".year", function(){
          $(".year").removeClass("selected");
          $(this).addClass("selected");
          $(".selected_year").html( $(this).html() );
          selectedYear = parseInt($(this).html());
          $(".m"+monthViewing).trigger("click");
          // YEAR IS SELECTED. DO SOMETHING WITH selectedYear.
        });

        function addDayBox(month, day, year, isToday){
            var dayOfWeek = getDayOfWeek(month, day, year);
            if (!isToday){
                $(".timeline").append('<div class="day d'+day+'"><div class="day_of_month">'+day+'</div><input type="button" class="add_event" value="+" title="Add Event"></input><div class="day_content"><h4 class="day_name">'+dayOfWeek+'</h4><ul class="day_list"></ul></div></div>');
            }
            else {
                $(".timeline").append('<div class="day d'+day+'"><div class="day_of_month">'+day+'</div><input type="button" class="add_event" value="+" title="Add Event"></input><div class="day_content today"><h4 class="day_name">'+dayOfWeek+'</h4><ul class="day_list"></ul></div></div>');
            }
        }



        $(".month_name:not(.year_select)").on("click", function(){
            $("li.month_name").removeClass("selected");
            $(this).addClass("selected");
            var month = $(this).attr("data-month");
            if (month != monthViewing || selectedYear != yearViewing){
                loadUpcomingEvents();
                $(".timeline").empty();
                $(".timeline")[0].scrollTop;
                monthViewing = month;
                yearViewing = selectedYear;
                var daysInMonth = getDaysInMonth(monthViewing, yearViewing);
                for (var day = 1; day <= daysInMonth; day++){
                    if (currentMonth == monthViewing && currentDay == day && currentYear == yearViewing){
                        addDayBox(monthViewing, day, yearViewing, true);
                    }
                    else {
                        addDayBox(monthViewing, day, yearViewing, false);
                    }
                }
                loadEvents(monthViewing, yearViewing);

            }
        });
        $(".m"+currentMonth).trigger("click");


        function hideLeftbar(time, button){
          $(".leftbar").velocity({left: "-260px"}, { duration: time, queue: false });
          $(".wrapper").velocity({left: "0px"}, { duration: time, queue: false });
          $(".wrapper").velocity({width: "100vw"}, { duration: time, queue: false });
          $(button).removeClass("glyphicon-chevron-left").addClass("glyphicon-chevron-right");
          $(button).velocity({left: "10px"}, { duration: time, queue: false });
        }
        function showLeftbar(time, button){
          $(".leftbar").velocity({left: "0px"}, { duration: time, queue: false });
          $(".wrapper").velocity({left: "260px"}, { duration: time, queue: false });
          $(".wrapper").velocity({width: "-=260px"}, { duration: time, queue: false });
          $(button).removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-left");
          $(button).velocity({left: "220px"}, { duration: time, queue: false });
          setTimeout(function(){
            $(".wrapper").css("width", "calc(100vw - 260px)");
          }, time + time)
        }
        $(".hide_leftbar").click(function(){
          if($(this).hasClass("glyphicon-chevron-left")){
            hideLeftbar(300, this);
          }else{
            showLeftbar(300, this);
          }
        });
        if($(window).width() < 825){
          hideLeftbar(0, ".hide_leftbar");
        }
      });
      window.onunload = function(){};
    </script>
  </body>
</html>
