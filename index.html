<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Morganizer</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link href="jbox/themes/TooltipDark.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <link href="jbox/jBox.css" rel="stylesheet">
    <script src="http://js.nicedit.com/nicEdit-latest.js" type="text/javascript"></script>
    <script type="text/javascript">
        bkLib.onDomLoaded(function() {

            new nicEditor({
                buttonList: ['bold', 'italic', 'underline', 'left', 'center', 'right', 'justify', 'ol', 'ul', 'removeformat', 'indent', 'outdent', 'hr', 'upload', 'link', 'unlink']
            }).panelInstance('main_textarea');

        });
    </script>
    <script type="text/javascript">
        if (localStorage.userToken == undefined) {
            location = "login";
        }
    </script>

</head>

<body class="index_body">
    <div id="audio-files" style="display: none;">
        <audio id="click-sound">
            <source src="jbox/audio/bling2.wav" type="audio/wav" />
        </audio>
    </div>
    <!-- NAVIGATION BAR -->
    <div class="nav_dropdown">
      <p onclick="location='index'" style="background-color: orange">Home</p>
      <p onclick="location='chat'">Chat</p>
      <p onclick="location='drive'">Drive</p>
      <p onclick="location='cal'">Calendar</p>
      <p onclick="location='networks'">Networks</p>
    </div>
    <div class="navigation_bar">
        <ul id="navbar_list">
          <li class="navbar_item navbar_title navbar_title_index">
              MorTeam
          </li>
          <li class="navbar_item searchbox_list_item">
              <input type="text" placeholder="search" class="searchbox"></input>
          </li>
          <li class="navbar_item glyph_link chat_btn menu_btn" onclick="location='chat'">
              <span class="glyphicon glyphicon-comment"></span>
          </li>
          <li class="navbar_item glyph_link drive_btn menu_btn" onclick="location='drive'">
              <span class="glyphicon glyphicon-hdd"></span>
          </li>
          <li class="navbar_item glyph_link cal_btn menu_btn" onclick="location='cal'">
              <span class="glyphicon glyphicon-calendar"></span>
          </li>
          <li class="navbar_item glyph_link networks_btn menu_btn" onclick="location='networks'">
              <span class="glyphicon glyphicon-globe"></span>
          </li>
          <div class="navbar_item right_links">
            <li class="navbar_item glyph_link menu">
                <span class="glyphicon glyphicon-menu-hamburger"></span>
            </li>
            <li class="navbar_item glyph_link" id="notif_button">
                <span class="glyphicon glyphicon-inbox"></span>
            </li>
            <img class="profile_id" id="small_prof_pic" src="./images/user.jpg"></img>
            <span class="profile_name" id="name_link"></span>
          </div>
        </ul>
    </div>
    <!-- <div class="triangle_thing_notif hidden"></div>
    <div class="triangle_thing_prof hidden"></div> -->
    <div id="notif_drop" class="hidden">
        <ul>
            <li class="notif_list_item">hey</li>
            <li class="notif_list_item">hi</li>
            <li class="notif_list_item">ho</li>
        </ul>
    </div>
    <div id="prof_drop" class="hidden">
        <ul>
            <li class="notif_list_item" onclick="location='profile';">View Profile and Settings</li>
            <li class="notif_list_item" id="logout_button">Log Out</li>
        </ul>
    </div>
    <div class="hidden" id="darken"></div>
    <!-- END OF NAVIGATION BAR -->
    <!-- BODY -->
    <div class="announcements_container" style="margin-top: 60px;">

        <div class="announcements_left">
          <p onclick="location='profile'">View Profile</p>
          <p id="logout_button">Log Out</p>
          <hr>
          <h5 style="margin-bottom: 15px;">Your Subdivisions</h5>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> Programming</p>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> MorScout</p>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> MorTeam</p>
          <hr>
          <h5 style="margin-bottom: 15px;">Public Subdivisions</h5>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> Build</p>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> Programming</p>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> Business</p>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> CAD</p>
          <p class="scope_link"><span class="glyphicon glyphicon-screenshot"></span> Media</p>
          <!-- <hr>
          <h5 style="margin-bottom: 15px;">This Group's Networks</h5>
          <p><span class="glyphicon glyphicon-globe"></span> FIRST Robotics Network</p>
          <p><span class="glyphicon glyphicon-globe"></span> Technology Network</p> -->
          <hr>
          <p class="new_pu_scope"><span class="glyphicon glyphicon-plus"></span> Make a Subdivision</p>
          <hr>
          <span>Â© 2015 MorTeam</span>
        </div>
        <div class="announcements_center">
          <div class="post_announcement cf">
              <textarea class="announcement_textarea" id="main_textarea" placeholder="Make an announcement..."></textarea>
              <input type="button" class="announcement_post_button" value="Post"></input>
              <div class=" announcement_audience_button btn-group">
                  <button class="button dropdown-toggle" data-toggle="dropdown"><span class="audience_selection">Everyone</span>
                      <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu audience_drop">
                      <li class="audience_item selected">Everyone</li>
                      <li class="audience_item">Build</li>
                      <li class="audience_item">Programming</li>
                      <li class="audience_item">Business</li>
                  </ul>
              </div>
          </div>
          <div class="announcements_list">
              <!-- <div class="announcement" data-postNum="1">
              <div class="announcement_top">
                <img id="medium_prof_pic" src="./images/user.jpg"></img>
                <span class="announcement_poster">Farbod Rafezy</span>
              </div>
              <span class="glyphicon glyphicon-remove delete_icon"></span><br>
              the words go here
            </div> -->
          </div>
        </div>
        <div class="announcements_right">
          <div class="ad" style="margin-top: 0px; position: fixed;"></div>
        </div>

    </div>
    <!-- END OF BODY -->
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="jbox/jBox.min.js"></script>
    <script type="text/javascript" src="js/socket.io.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.1/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script type="text/javascript" src="js/autosize.js"></script>
    <script type="text/javascript">
        autosize(document.querySelectorAll('textarea'));
    </script>
    <script type="text/javascript">
        // FUNCTION DEFINITIONS
        function createPost(text) {
            //var title = localStorage.title
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
            var now = new Date();
            var nameDate = localStorage.firstName + ' ' + localStorage.lastName + ' - ' + months[now.getMonth()] + ' ' + now.getDate() + ', ' + now.getFullYear() + ' - ' + getTimeNow();
            var postNum = 1;
            if ($('.announcement').first().length > 0) {
                postNum = parseInt($('.announcement').first().attr('data-postNum')) + 1;
            }
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/announce", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    console.log(xhr.responseText);
                    if (xhr.responseText == "success") {
                        var $newMsg = $('<div class="announcement" data-postNum="' + postNum + '"><div class="announcement_top"><img id="medium_prof_pic" src="/f/getPic?user='+localStorage.username+'" onError="this.src=\'./images/user.jpg\'""></img><span class="announcement_poster">' +
                            nameDate + '</span></div><span class="glyphicon glyphicon-remove delete_icon"></span><br>' + text.replace(/\n\r?/g, '<br />') + '</div>')
                        $('.announcements_list').prepend($newMsg).isotope('prepended', $newMsg)

                        document.getElementById('main_textarea').value = "";
                        $('#main_textarea').css("height", "56px");
                        getPic(localStorage.username, $("#medium_prof_pic"));
                    }
                }
            };
            //var code = localStorage.teamCode;
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "nameDate": nameDate,
                "text": text.replace(/\n\r?/g, '<br />').replace(/'/g, "''")
            }));
        }

        function getAnnouncements() {
            //var code = localStorage.teamCode
            //var title = localStorage.title
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getannouncements", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var announcements = JSON.parse(xhr.responseText);
                        for (var i = announcements.length - 1; i > -1; i--) {
                            var nameDate = announcements[i].nameDate;
                            var user = announcements[i].user;
                            var text = announcements[i].text.replace(/\n\r?/g, '<br />');
                            var postNum = announcements[i].postNum;
                            $('.announcements_list').append('<div class="announcement" data-postNum="' + postNum + '"><div class="announcement_top"><img id="medium_prof_pic" class="poster_pic' + i +
                                '" src="/f/getPic?user='+user+'" onError="this.src=\'./images/user.jpg\'"></img><span class="announcement_poster">' + nameDate + '</span></div><span class="glyphicon glyphicon-remove delete_icon"></span><br>' + text.replace(/\n\r?/g, '<br />') + '</div>')
                            document.getElementById('main_textarea').value = "";
                            $('#main_textarea').css("height", "56px");
                            /*var prof_pic_class = ".poster_pic" + i;
                            var target = $(prof_pic_class);
                            getPic(user, target);*/
                        }
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "title": "PUT TITLE)"
            }));
        }

        function deletePost() {
            //
        }
        function loadUsersOnScopeModal(modal) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getteammates", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var users = JSON.parse(xhr.responseText);
                        people = users;
                        var content = "";
                        for (var i = 0; i < people.length; i++) {
                            var person = people[i].first + " " + people[i].last;
                            var nameP = "<p class='selected_scope_member' data-username='" + people[i].user + "'>" + person + "</p>"
                            content += nameP;
                        }
                        var modal_content = '<input type="text" class="scope_name" placeholder="Subdivision Name"></input><br/><p class="scope_type public_scope selected">Public</p><p class="scope_type private_scope">Private</p><span class="glyphicon glyphicon-question-sign scope_help" title="A public subdivision can be seen and<br/> joined by anyone in the team, but joining<br/> a private subdivision requires an invitation."></span><br/>Invite some initial members:<br/><input type="text" placeholder="Search Names..." id="select_scope_members"></input><br/><div id="selected_scope_members">' +
                        content + '</div><br/><input type="button" class="button make_scope_button" value="Make Subdivision"></input>'
                        modal.setContent(modal_content);
                        $('.scope_help').jBox('Tooltip', {
                            delayOpen: 0,
                            delayClose: 300,
                            theme: "TooltipDark",
                            position: {
                                y: 'bottom'
                            }
                        });
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "teamCode":localStorage.teamCode
            }));
        }
        $(document).ready(function() {

            getAnnouncements(); // getting announcements is first priority on this page

            scope_modal = new jBox('Modal', {
              title: 'New Subdivision',
              width: 350,
              height: 355,
              onOpen: function() {
                  // didClickNew = false;
                  loadUsersOnScopeModal(scope_modal);
                  $(document).on("keyup", '#select_scope_members', function() {
                    var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                    $('#selected_scope_members p').show().filter(function() {
                        var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                        console.log(!~text.indexOf(val));
                        return !~text.indexOf(val);
                    }).hide();
                  });
                  $(document).one("click", '.make_scope_button', function() {
                    // CODE TO CREATE SCOPE HERE
                        // didClickNew = true;
                  });
              }
            });
            loadUsersOnScopeModal(scope_modal);

            $(document).on("click", ".new_pu_scope", function(){
              scope_modal.open();
            });
            $(document).on("click", ".new_pr_scope", function(){
              scope_modal.open();
            });

            $(document).on("click", ".selected_scope_member", function() {
                // do stuff with $(this) when a name has been clicked in group_modal
                if ($(this).hasClass("clicked")) {
                    $(this).removeClass("clicked");
                } else {
                    $(this).addClass('clicked');
                }
            });
            $(document).on("click", ".scope_type", function(){
              $(".scope_type").removeClass("selected");
              $(this).addClass("selected");
            });
            $(document).on("click", ".scope_help", function(){

            })


            var audience = "Everyone";

            $(document).on("click", ".audience_item", function(){
              $(".audience_item").removeClass("selected");
              $(this).addClass("selected");
              $(".audience_selection").html( $(this).html() );
              audience = $(this).html();
            });

            $('.announcement_post_button').click(function() {
                var message = (new nicEditors.findEditor('main_textarea')).getContent();
                var comExists = message.indexOf(".com") > -1;
                var coExists = message.indexOf(".co.") > -1;
                var orgExists = message.indexOf(".org") > -1;
                var netExists = message.indexOf(".net") > -1;
                var httpExists = (message.indexOf("http://") > -1 && (comExists || coExists || orgExists || netExists));
                var wwwExists = (message.indexOf("www.") > -1 && (comExists || coExists || orgExists || netExists));
                var linkExists = httpExists || wwwExists || comExists || coExists || orgExists || netExists;
                if (linkExists) { // checks for manually typed links in announcement
                    // wrap link with <a> tags
                }
                createPost(message) // posts announcement
                nicEditors.findEditor('main_textarea').setContent('');

            });
            $(document).on("click", ".delete_icon", function() {
                if (window.confirm("Are you sure?")) {
                    var target = $(this).parent();
                    var data = JSON.stringify({
                        "postNum": parseInt(target.attr('data-postNum')),
                        "user": localStorage.username
                    })
                    $.post("/f/deletePost", data, function(response) {
                        if (response == "success") {
                            $ann.isotope('remove', target).isotope();
                        }
                    });
                }
            });


        });
        $(window).load(function(){
          $("div.nicEdit-main").addClass('wordwrap');
          var textareaWidthNum;
          var textareaWidth;
          $(window).resize(function(){
            textareaWidthNum = $(".post_announcement").width();
            textareaWidth = textareaWidthNum + "px";
            $(".nicEdit-main").css("width", textareaWidth);
            $(".post_announcement").children().not(".announcement_post_button").not(".announcement_audience_button").css("width", textareaWidth);
            console.log($(".nicEdit-main").css("width"));
          });

          setTimeout(function(){
              $ann = $(".announcements_list").isotope({
                  itemSelector: ".announcement",
                  layoutMode: "vertical"
              });
          }, 1);
          $(document).on("click", ".scope_link", function(){
            location="subdivision";
          });
        })
        window.onunload = function() {};
    </script>
    <script type="text/javascript" src="js/main.js"></script>
</body>

</html>
