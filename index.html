<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Morganizer</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <link href="jbox/jBox.css" rel="stylesheet">
    <script src="http://js.nicedit.com/nicEdit-latest.js" type="text/javascript"></script>
    <script type="text/javascript">
        bkLib.onDomLoaded(function() {

            new nicEditor({
                buttonList: ['bold', 'italic', 'underline', 'left', 'center', 'right', 'justify', 'ol', 'ul', 'removeformat', 'indent', 'outdent', 'hr', 'upload', 'link', 'unlink']
            }).panelInstance('main_textarea');

        });
    </script>
    <script type="text/javascript">
        if (localStorage.userToken == undefined) {
            location = "login.html";
        }
    </script>

</head>

<body class="index_body">
    <div id="audio-files" style="display: none;">
        <audio id="click-sound">
            <source src="jbox/audio/bling2.wav" type="audio/wav" />
        </audio>
    </div>
    <!-- NAVIGATION BAR -->
    <div class="nav_dropdown">
      <p onclick="location='index.html'" style="background-color: orange">Home</p>
      <p onclick="location='chat.html'">Chat</p>
      <p onclick="location='drive.html'">Drive</p>
      <p onclick="location='cal.html'">Calendar</p>
      <p onclick="location='networks.html'">Networks</p>
    </div>
    <div class="navigation_bar">
        <ul id="navbar_list">
          <li class="navbar_item navbar_title navbar_title_index">
              MorTeam
          </li>
          <li class="navbar_item searchbox_list_item">
              <input type="text" placeholder="search" class="searchbox"></input>
          </li>
          <li class="navbar_item glyph_link chat_btn menu_btn" onclick="location='chat.html'">
              <span class="glyphicon glyphicon-comment"></span>
          </li>
          <li class="navbar_item glyph_link drive_btn menu_btn" onclick="location='drive.html'">
              <span class="glyphicon glyphicon-hdd"></span>
          </li>
          <li class="navbar_item glyph_link cal_btn menu_btn" onclick="location='cal.html'">
              <span class="glyphicon glyphicon-calendar"></span>
          </li>
          <li class="navbar_item glyph_link networks_btn menu_btn" onclick="location='networks.html'">
              <span class="glyphicon glyphicon-globe"></span>
          </li>
          <div class="navbar_item right_links">
            <li class="navbar_item glyph_link menu">
                <span class="glyphicon glyphicon-menu-hamburger"></span>
            </li>
            <li class="navbar_item glyph_link" id="notif_button">
                <span class="glyphicon glyphicon-inbox"></span>
            </li>
            <img class="profile_id" id="small_prof_pic" src="./images/user.jpg"></img>
            <span class="profile_name" id="name_link"></span>
          </div>
        </ul>
    </div>
    <!-- <div class="triangle_thing_notif hidden"></div>
    <div class="triangle_thing_prof hidden"></div> -->
    <div id="notif_drop" class="hidden">
        <ul>
            <li class="notif_list_item">hey</li>
            <li class="notif_list_item">hi</li>
            <li class="notif_list_item">ho</li>
        </ul>
    </div>
    <div id="prof_drop" class="hidden">
        <ul>
            <li class="notif_list_item" onclick="location='profile.html';">View Profile</li>
            <li class="notif_list_item" id="logout_button">Log Out</li>
        </ul>
    </div>
    <div class="hidden" id="darken"></div>
    <!-- END OF NAVIGATION BAR -->
    <!-- BODY -->
    <div class="announcements_container" style="margin-top: 60px;">

        <div class="announcements_left">
          <p>View Profile</p>
          <p>Edit Profile</p>
          <p>Log Out</p>
          <hr>
          <h5 style="margin-bottom: 15px;">Your Scopes in This Group</h5>
          <p><span class="glyphicon glyphicon-screenshot"></span> Programming</p>
          <p><span class="glyphicon glyphicon-screenshot"></span> MorScout</p>
          <p><span class="glyphicon glyphicon-screenshot"></span> MorTeam</p>
          <hr>
          <!-- <h5 style="margin-bottom: 15px;">Your Groups</h5>
          <p style="font-weight: 400; background: #f4f4f4"><span class="glyphicon glyphicon-link"></span> MorTorq</p>
          <p><span class="glyphicon glyphicon-link"></span> BHHS</p>
          <p><span class="glyphicon glyphicon-link"></span> Random Volunteership</p>
          <hr> -->
          <h5 style="margin-bottom: 15px;">This Group's Networks</h5>
          <p><span class="glyphicon glyphicon-globe"></span> FIRST Robotics Network</p>
          <p><span class="glyphicon glyphicon-globe"></span> Technology Network</p>
        </div>
        <div class="announcements_center">
          <div class="post_announcement">
              <textarea class="announcement_textarea" id="main_textarea" placeholder="Make an announcement..."></textarea>
              <input type="button" class="announcement_post_button" value="Post"></input>
          </div>
          <div class="announcements_list">
              <!-- <div class="announcement" data-postNum="1">
              <div class="announcement_top">
                <img id="medium_prof_pic" src="./images/user.jpg"></img>
                <span class="announcement_poster">Farbod Rafezy</span>
              </div>
              <span class="glyphicon glyphicon-remove delete_icon"></span><br>
              the words go here
            </div> -->
          </div>
        </div>
        <div class="announcements_right">
          <div class="ad" style="margin-top: 0px; position: fixed;"></div>
        </div>

    </div>
    <!-- END OF BODY -->
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="jbox/jBox.min.js"></script>
    <script type="text/javascript" src="js/socket.io.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.1/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script type="text/javascript" src="js/autosize.js"></script>
    <script type="text/javascript">
        autosize(document.querySelectorAll('textarea'));
    </script>
    <script type="text/javascript">
        // FUNCTION DEFINITIONS
        function createPost(text) {
            //var title = localStorage.title
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
            var now = new Date();
            var nameDate = localStorage.firstName + ' ' + localStorage.lastName + ' - ' + months[now.getMonth()] + ' ' + now.getDate() + ', ' + now.getFullYear() + ' - ' + getTimeNow();
            var postNum = 1;
            if ($('.announcement').first().length > 0) {
                postNum = parseInt($('.announcement').first().attr('data-postNum')) + 1;
            }
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/announce", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    console.log(xhr.responseText);
                    if (xhr.responseText == "success") {
                        var $newMsg = $('<div class="announcement" data-postNum="' + postNum + '"><div class="announcement_top"><img id="medium_prof_pic" src="/f/getPic?user='+localStorage.username+'" onError="this.src=\'./images/user.jpg\'""></img><span class="announcement_poster">' +
                            nameDate + '</span></div><span class="glyphicon glyphicon-remove delete_icon"></span><br>' + text.replace(/\n\r?/g, '<br />') + '</div>')
                        $('.announcements_list').prepend($newMsg).isotope('prepended', $newMsg)

                        document.getElementById('main_textarea').value = "";
                        $('#main_textarea').css("height", "56px");
                        getPic(localStorage.username, $("#medium_prof_pic"));
                    }
                }
            };
            //var code = localStorage.teamCode;
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "nameDate": nameDate,
                "text": text.replace(/\n\r?/g, '<br />').replace(/'/g, "''")
            }));
        }

        function getAnnouncements() {
            //var code = localStorage.teamCode
            //var title = localStorage.title
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getannouncements", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var announcements = JSON.parse(xhr.responseText);
                        for (var i = announcements.length - 1; i > -1; i--) {
                            var nameDate = announcements[i].nameDate;
                            var user = announcements[i].user;
                            var text = announcements[i].text.replace(/\n\r?/g, '<br />');
                            var postNum = announcements[i].postNum;
                            $('.announcements_list').append('<div class="announcement" data-postNum="' + postNum + '"><div class="announcement_top"><img id="medium_prof_pic" class="poster_pic' + i +
                                '" src="/f/getPic?user='+user+'" onError="this.src=\'./images/user.jpg\'"></img><span class="announcement_poster">' + nameDate + '</span></div><span class="glyphicon glyphicon-remove delete_icon"></span><br>' + text.replace(/\n\r?/g, '<br />') + '</div>')
                            document.getElementById('main_textarea').value = "";
                            $('#main_textarea').css("height", "56px");
                            /*var prof_pic_class = ".poster_pic" + i;
                            var target = $(prof_pic_class);
                            getPic(user, target);*/
                        }
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "title": "PUT TITLE)"
            }));
        }

        function deletePost() {
            //
        }

        $(document).ready(function() {

            getAnnouncements(); // getting announcements is first priority on this page

            $('.announcement_post_button').click(function() {
                var message = (new nicEditors.findEditor('main_textarea')).getContent();
                var comExists = message.indexOf(".com") > -1;
                var coExists = message.indexOf(".co.") > -1;
                var orgExists = message.indexOf(".org") > -1;
                var netExists = message.indexOf(".net") > -1;
                var httpExists = (message.indexOf("http://") > -1 && (comExists || coExists || orgExists || netExists));
                var wwwExists = (message.indexOf("www.") > -1 && (comExists || coExists || orgExists || netExists));
                var linkExists = httpExists || wwwExists || comExists || coExists || orgExists || netExists;
                if (linkExists) { // checks for manually typed links in announcement
                    // wrap link with <a> tags
                }
                createPost(message) // posts announcement

            });
            $(document).on("click", ".delete_icon", function() {
                if (window.confirm("Are you sure?")) {
                    var target = $(this).parent();
                    var data = JSON.stringify({
                        "postNum": parseInt(target.attr('data-postNum')),
                        "user": localStorage.username
                    })
                    $.post("/f/deletePost", data, function(response) {
                        if (response == "success") {
                            $ann.isotope('remove', target).isotope();
                        }
                    });
                }
            });


        });
        $(window).load(function(){
          $("div.nicEdit-main").addClass('wordwrap');
          var textareaWidthNum;
          var textareaWidth;
          $(window).resize(function(){
            textareaWidthNum = $(".post_announcement").width();
            textareaWidth = textareaWidthNum + "px";
            $(".nicEdit-main").css("width", textareaWidth);
            $(".post_announcement").children().not(".announcement_post_button").css("width", textareaWidth);
            console.log($(".nicEdit-main").css("width"));
          });

          setTimeout(function(){
              $ann = $(".announcements_list").isotope({
                  itemSelector: ".announcement",
                  layoutMode: "vertical"
              });
            }, 1);
        })
        window.onunload = function() {};
    </script>
    <script type="text/javascript" src="js/main.js"></script>
</body>

</html>
